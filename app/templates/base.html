<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bowl-A-Lyzer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        :root {
            /* Color Palette */
            --color-green-light: #a1e8c4;   /* Lightest green */
            --color-green: #86e1b3;         /* Light green */
            --color-blue-lightest: #7dcfe6; /* Light blue-green */
            --color-blue-light: #4aa8c2;    /* Light blue */
            --color-blue: #0a9dc7;          /* Dark blue */


            /* Semantic Color Assignments */
            --theme-primary: var(--color-blue);         /* Main UI elements like navbar, card headers */
            --theme-secondary: var(--color-blue-light); /* Buttons, interactive elements */
            --theme-accent: var(--color-blue-lightest); /* Highlights, accents */
            --theme-warning: var(--color-green);        /* Warning states */
            --theme-info: var(--color-green-light);     /* Info states */
            
            /* Background Colors */
            --theme-background: #f8f9fa;
            --theme-surface: #ffffff;
            
            /* Text Colors */
            --theme-text-on-primary: #ffffff;
            --theme-text-on-secondary: #ffffff;
            --theme-text-on-light: var(--color-blue);
        }

        body {
            background-color: var(--theme-background);
            color: var(--theme-text-on-light);
        }

        .navbar {
            background-color: var(--theme-primary) !important;
        }

        .navbar-brand, .nav-link {
            color: var(--theme-text-on-primary) !important;
        }

        .card {
            border-color: var(--theme-primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            background-color: var(--theme-surface);
        }

        .card-header {
            background-color: var(--theme-primary);
            color: var(--theme-text-on-primary);
        }

        /* Button Styles */
        .btn-primary {
            background-color: var(--theme-secondary);
            border-color: var(--theme-secondary);
            color: var(--theme-text-on-secondary);
        }

        .btn-primary:hover {
            background-color: var(--theme-primary);
            border-color: var(--theme-primary);
            color: var(--theme-text-on-primary);
        }

        /* Outline Button Variants */
        .btn-outline-primary {
            color: var(--theme-secondary);
            border-color: var(--theme-secondary);
        }

        .btn-outline-primary:hover {
            background-color: var(--theme-secondary);
            border-color: var(--theme-secondary);
            color: var(--theme-text-on-secondary);
        }

        /* Active state for radio buttons */
        .btn-check:checked + .btn-outline-primary {
            background-color: var(--theme-secondary);
            border-color: var(--theme-secondary);
            color: var(--theme-text-on-secondary);
        }

        .btn-check:active + .btn-outline-primary, 
        .btn-check:checked + .btn-outline-primary:focus {
            background-color: var(--theme-secondary);
            border-color: var(--theme-secondary);
            color: var(--theme-text-on-secondary);
        }

        /* Unselected state for radio buttons - ensure white background */
        .btn-check:not(:checked) + .btn-outline-primary {
            background-color: white !important;
            border-color: var(--theme-secondary);
            color: var(--theme-secondary);
        }

        .btn-secondary {
            background-color: var(--theme-accent);
            border-color: var(--theme-accent);
            color: var(--theme-text-on-light);
        }

        .btn-secondary:hover {
            background-color: var(--theme-warning);
            border-color: var(--theme-warning);
            color: var(--theme-text-on-light);
        }

        /* Alert Styles */
        .alert-danger {
            background-color: var(--theme-warning);
            border-color: var(--theme-warning);
            color: var(--theme-text-on-light);
        }

        .alert-info {
            background-color: var(--theme-info);
            border-color: var(--theme-info);
            color: var(--theme-text-on-light);
        }

        .alert-warning {
            background-color: var(--theme-warning);
            border-color: var(--theme-warning);
            color: var(--theme-text-on-light);
        }
    </style>
</head>
<body>
    <!-- Include navbar component -->
    {% include 'components/navbar.html' %}

    <!-- Main content -->
    <div class="container">
        {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Language switching functionality -->
    <script>
        // Global translations object
        let translations = {};
        let currentLanguage = 'en';
        
        // Make translations globally accessible
        window.translations = translations;
        
        // Initialize language system
        document.addEventListener('DOMContentLoaded', function() {
            loadTranslations();
            setupLanguageToggle();
        });
        
        // Load translations
        async function loadTranslations() {
            try {
                const response = await fetch('/league/get_translations');
                
                if (!response.ok) {
                    console.error('❌ HTTP error loading translations:', response.status, response.statusText);
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    translations = data.translations;
                    currentLanguage = data.current_language;
                    updateLanguageDisplay(currentLanguage);
                    
                    // Update page content with new translations
                    updatePageContent();
                } else {
                    console.error('❌ Failed to load translations:', data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('❌ Error loading translations:', error);
            }
        }
        
        // Update page content with translations
        function updatePageContent() {
            // Update all elements with data-i18n attributes
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[key]) {
                    element.textContent = translations[key];
                }
            });
            
            // Update chart labels if charts exist
            updateChartLabels();
        }
        
        // Update chart labels
        function updateChartLabels() {
            const matchDayLabel = translations['match_day_label'] || 'Match Day';
            const matchDayFormat = translations['match_day_format'] || 'Match Day #{week}';
            
            // Update any existing Chart.js charts that use week labels
            if (typeof Chart !== 'undefined') {
                // Find all canvas elements that might have charts
                const canvasElements = document.querySelectorAll('canvas');
                canvasElements.forEach(canvas => {
                    try {
                        // Try to get the chart instance from the canvas
                        const chart = Chart.getChart ? Chart.getChart(canvas) : null;
                        if (chart && chart.config && chart.config.data && chart.config.data.labels) {
                            // Update x-axis labels that contain "Match Day"
                            chart.config.data.labels = chart.config.data.labels.map(label => {
                                if (typeof label === 'string' && label.includes('Match Day')) {
                                    // Extract week number if present
                                    const weekMatch = label.match(/Match Day #?(\d+)/);
                                    if (weekMatch) {
                                        const week = weekMatch[1];
                                        return matchDayFormat.replace('{week}', week);
                                    }
                                    return label.replace('Match Day', matchDayLabel);
                                }
                                return label;
                            });
                            chart.update();
                        }
                    } catch (error) {
                        // Ignore errors for canvases without charts
                        console.debug('Canvas without chart:', error);
                    }
                });
            }
            
            // Update Highcharts if they exist
            if (typeof Highcharts !== 'undefined' && Highcharts.charts) {
                Highcharts.charts.forEach(chart => {
                    if (chart && chart.xAxis && chart.xAxis[0]) {
                        const xAxis = chart.xAxis[0];
                        if (xAxis.categories) {
                            xAxis.categories = xAxis.categories.map(category => {
                                if (typeof category === 'string' && category.includes('Match Day')) {
                                    const weekMatch = category.match(/Match Day #?(\d+)/);
                                    if (weekMatch) {
                                        const week = weekMatch[1];
                                        return matchDayFormat.replace('{week}', week);
                                    }
                                    return category.replace('Match Day', matchDayLabel);
                                }
                                return category;
                            });
                            chart.redraw();
                        }
                    }
                });
            }
        }
        
        // Helper function to get translated text
        function t(key) {
            return translations[key] || key;
        }
        
        // Setup language toggle functionality
        function setupLanguageToggle() {
            const languageItems = document.querySelectorAll('[data-language]');
            
            languageItems.forEach(item => {
                item.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const language = this.getAttribute('data-language');
                    await switchLanguage(language);
                });
            });
        }
        
        // Switch language
        async function switchLanguage(language) {
            try {
                const response = await fetch('/league/set_language', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: language })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentLanguage = language;
                    await loadTranslations();
                    
                    // Update all content immediately without page reload
                    updatePageContent();
                    
                    // Refresh current data to update table headers and chart labels
                    refreshCurrentData();
                    
                    // Dispatch language change event for apps to listen to
                    window.dispatchEvent(new CustomEvent('languageChanged', { 
                        detail: { language: language } 
                    }));
                }
            } catch (error) {
                console.error('Error switching language:', error);
            }
        }
        
        // Make switchLanguage globally available
        window.switchLanguage = switchLanguage;
        
        // Refresh current data to update table headers and chart labels
        function refreshCurrentData() {
            console.log('🔄 Refreshing current data for language change');
            
            // Check if we're on the league stats page
            if (window.location.pathname.includes('/league/stats')) {
                // Trigger content refresh for league stats
                if (typeof window.leagueStatsApp !== 'undefined' && window.leagueStatsApp.renderContent) {
                    console.log('🔄 Refreshing league stats content');
                    window.leagueStatsApp.renderContent();
                } else {
                    // Fallback to legacy refresh
                    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
                    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
                    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
                    const selectedTeam = document.querySelector('input[name="team"]:checked')?.value;
                    
                    if (selectedSeason && selectedLeague) {
                        // Refresh league table
                        if (selectedWeek) {
                            updateTableLeagueWeek();
                        } else {
                            updateTableLeagueHistory();
                        }
                        
                        // Refresh team details if team is selected
                        if (selectedTeam && selectedWeek) {
                            updateTableTeamDetails();
                        }
                        
                        // Refresh charts
                        if (typeof updateChartsLeague === 'function') {
                            updateChartsLeague();
                        }
                    }
                }
            }
            
            // Check if we're on the team stats page
            if (window.location.pathname.includes('/team/stats')) {
                // Trigger content refresh for team stats
                if (typeof window.teamStatsApp !== 'undefined' && window.teamStatsApp.renderContent) {
                    console.log('🔄 Refreshing team stats content');
                    window.teamStatsApp.renderContent();
                }
            }
            
            // Check if we're on the API test page
            if (window.location.pathname.includes('/test')) {
                // Trigger content refresh for API test
                if (typeof window.apiTestApp !== 'undefined' && window.apiTestApp.renderContent) {
                    console.log('🔄 Refreshing API test content');
                    window.apiTestApp.renderContent();
                }
            }
        }
        
        // Update language display in navbar
        function updateLanguageDisplay(language) {
            const flagElement = document.getElementById('currentLanguageFlag');
            const textElement = document.getElementById('currentLanguageText');
            
            if (flagElement && textElement) {
                if (language === 'de') {
                    flagElement.textContent = '🇩🇪';
                    textElement.textContent = 'Deutsch';
                } else if (language === 'en') {
                    flagElement.textContent = '🇺🇸';
                    textElement.textContent = 'English';
                }
            }
        }
        
        // Setup language selector
        function setupLanguageSelector() {
            const languageItems = document.querySelectorAll('[data-language]');
            
            languageItems.forEach(item => {
                item.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const language = this.getAttribute('data-language');
                    await switchLanguage(language);
                });
            });
        }
        
        // Setup palette selector
        function setupPaletteSelector() {
            const paletteItems = document.querySelectorAll('.palette-option');
            
            paletteItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const palette = this.getAttribute('data-palette');
                    switchPalette(palette);
                });
            });
        }
        
        // Switch palette
        function switchPalette(palette) {
            // Update palette display
            const textElement = document.getElementById('currentPaletteText');
            if (textElement) {
                if (palette === 'harmonic10') {
                    textElement.textContent = 'Harmonic 10';
                } else if (palette === 'rainbowPastel') {
                    textElement.textContent = 'Rainbow Pastel';
                }
            }
            
            // Trigger palette change event
            window.dispatchEvent(new CustomEvent('paletteChanged', { detail: { palette } }));
        }
        
        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing application...');
            
            // Setup selectors
            setupLanguageSelector();
            setupPaletteSelector();
            
            // Load initial data
            loadTranslations();
            
            // Setup global database change listener
            setupGlobalDatabaseListener();
            
            console.log('✅ Application initialized');
        });
        
        // Global database change listener
        function setupGlobalDatabaseListener() {
            window.addEventListener('databaseChanged', async (event) => {
                console.log('🌐 Global database change detected:', event.detail);
                
                // Wait a moment for the server to process the change
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Try to refresh any active components
                await refreshActiveComponents();
            });
        }
        
        // Refresh active components based on current page
        async function refreshActiveComponents() {
            const currentPath = window.location.pathname;
            
            try {
                if (currentPath.includes('/league/')) {
                    await refreshLeagueComponents();
                } else if (currentPath.includes('/team/')) {
                    await refreshTeamComponents();
                } else if (currentPath.includes('/player/')) {
                    await refreshPlayerComponents();
                } else {
                    // Generic refresh for other pages
                    await refreshGenericComponents();
                }
            } catch (error) {
                console.error('Error refreshing components:', error);
            }
        }
        
        async function refreshLeagueComponents() {
            console.log('🔄 Refreshing league components...');
            
            // Try to refresh league-specific components
            const methods = [
                'updateSeasonButtons',
                'updateLeagueButtons',
                'updateWeekButtons', 
                'updateTeamButtons',
                'updateTableLeagueHistory',
                'updateTableLeagueWeek',
                'updateChartsLeague'
            ];
            
            for (const method of methods) {
                if (typeof window[method] === 'function') {
                    try {
                        await window[method]();
                    } catch (error) {
                        console.warn(`Error calling ${method}:`, error);
                    }
                }
            }
        }
        
        async function refreshTeamComponents() {
            console.log('🔄 Refreshing team components...');
            
            const methods = [
                'updateTeamSelect',
                'updateSeasonButtons',
                'updateWeeksData',
                'updateTeamHistory',
                'updateLeagueComparison',
                'updateClutchAnalysis',
                'updateConsistencyMetrics',
                'updateSpecialMatches'
            ];
            
            for (const method of methods) {
                if (typeof window[method] === 'function') {
                    try {
                        await window[method]();
                    } catch (error) {
                        console.warn(`Error calling ${method}:`, error);
                    }
                }
            }
        }
        
        async function refreshPlayerComponents() {
            console.log('🔄 Refreshing player components...');
            
            const methods = [
                'loadPlayerStats',
                'displayLifetimeStats',
                'displaySeasonStats',
                'updateTrendChart'
            ];
            
            for (const method of methods) {
                if (typeof window[method] === 'function') {
                    try {
                        await window[method]();
                    } catch (error) {
                        console.warn(`Error calling ${method}:`, error);
                    }
                }
            }
        }
        
        async function refreshGenericComponents() {
            console.log('🔄 Refreshing generic components...');
            
            const methods = [
                'refreshCurrentData',
                'handleDataSourceChange',
                'updateContent',
                'renderContent'
            ];
            
            for (const method of methods) {
                if (typeof window[method] === 'function') {
                    try {
                        await window[method]();
                    } catch (error) {
                        console.warn(`Error calling ${method}:`, error);
                    }
                }
            }
        }
        
        // Helper functions for database parameter handling
        function getCurrentDatabase() {
            const urlParams = new URLSearchParams(window.location.search);
            const database = urlParams.get('database') || 'db_real';
            console.log('🔄 getCurrentDatabase called, returning:', database);
            return database;
        }
        
        function addDatabaseParam(url) {
            const database = getCurrentDatabase();
            if (database) {
                // Handle both string and URL objects
                const urlString = url.toString();
                const separator = urlString.includes('?') ? '&' : '?';
                return `${urlString}${separator}database=${encodeURIComponent(database)}`;
            }
            return url;
        }
        
        function fetchWithDatabase(url, options = {}) {
            const urlWithDatabase = addDatabaseParam(url);
            console.log('🔄 fetchWithDatabase called:', { originalUrl: url, urlWithDatabase });
            return fetch(urlWithDatabase, options);
        }
    </script>
    
    {% block scripts %}{% endblock %}
    
    <!-- Footer -->
    <footer class="bg-light mt-5 py-3">
        <div class="container">
            <div class="row">
                <div class="col-12 text-center">
                    <small class="text-muted">
                        © 2024 Bowl-A-Lyzer | 
                        <a href="{{ url_for('main.impressum') }}" class="text-decoration-none">Impressum</a>
                    </small>
                </div>
            </div>
        </div>
    </footer>
</body>
</html> 