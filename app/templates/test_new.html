{% extends "base.html" %}

{% block title %}API Test Page{% endblock %}

{% block content %}
{% include "components/tables.html" %}
{% include "components/charts.html" %}

<div class="container-fluid">
    <div class="row">
        <!-- Header -->
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="mb-1">API Test Center</h1>
                    <p class="text-muted mb-0">Test and explore API endpoints with the content block architecture</p>
                </div>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary" onclick="window.apiTestApp.debug()">
                        <i class="bi bi-bug me-1"></i>Debug
                    </button>
                    <button class="btn btn-outline-secondary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-funnel me-2"></i>Filter Controls
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Season Filter -->
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label">Season</label>
                            <div id="seasonSelector" class="btn-group-vertical w-100">
                                <!-- Season options will be inserted here -->
                                <div class="text-center py-2">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- League Filter -->
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label">League</label>
                            <div id="leagueSelector" class="btn-group-vertical w-100">
                                <!-- League options will be inserted here -->
                                <div class="text-center py-2">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Week Filter -->
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label">Week</label>
                            <div id="weekSelector" class="btn-group-vertical w-100">
                                <span class="text-muted">Select season and league first</span>
                            </div>
                        </div>

                        <!-- Team Filter -->
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label">Team</label>
                            <div id="teamSelector" class="btn-group-vertical w-100">
                                <span class="text-muted">Select season and league first</span>
                            </div>
                        </div>
                    </div>

                    <!-- Current Filter State Display -->
                    <div class="current-filters mt-3">
                        <small class="text-muted">Active Filters:</small>
                        <div class="filter-display">
                            <span class="text-muted">No filters selected</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Route Testing Block -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-api me-2"></i>API Route Testing
                    </h5>
                </div>
                <div class="card-body">
                    <div id="routeTestContainer">
                        <!-- Route test content will be rendered here -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Initializing route testing interface...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response Display Block -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-code-square me-2"></i>Response Viewer
                    </h5>
                </div>
                <div class="card-body">
                    <div id="responseDisplayContainer">
                        <!-- Response display content will be rendered here -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Initializing response viewer...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Testing Tools -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-tools me-2"></i>Advanced Testing Tools
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-info" onclick="this.performanceTest()">
                                    <i class="bi bi-speedometer2 me-1"></i>
                                    Performance Test
                                </button>
                            </div>
                            <small class="text-muted">Test response times for all endpoints</small>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-warning" onclick="this.stressTest()">
                                    <i class="bi bi-lightning me-1"></i>
                                    Stress Test
                                </button>
                            </div>
                            <small class="text-muted">Test endpoints under load</small>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid">
                                <button class="btn btn-outline-success" onclick="this.exportReport()">
                                    <i class="bi bi-download me-1"></i>
                                    Export Report
                                </button>
                            </div>
                            <small class="text-muted">Export test results as report</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Styles for API Test Page -->
<style>
.json-key { color: #d73a49; }
.json-string { color: #032f62; }
.json-number { color: #005cc5; }
.json-boolean { color: #e36209; }
.json-null { color: #6f42c1; }

.route-item {
    transition: all 0.2s ease;
}

.route-item:hover {
    background-color: #f8f9fa;
    border-color: #6f42c1 !important;
}

.route-endpoint {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    background-color: #f1f3f4;
    padding: 2px 6px;
    border-radius: 3px;
}

.btn-group-vertical .btn-check:checked + .btn {
    background-color: #6f42c1;
    border-color: #6f42c1;
}

.alert-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.json-display {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    font-size: 0.8rem;
    line-height: 1.4;
}

.filter-display .badge {
    font-size: 0.7rem;
}

.card-header .card-title {
    font-weight: 600;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}
</style>

<!-- Import Required Dependencies -->
<script src="{{ url_for('static', filename='js/core/url-state-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/core/centralized-button-manager.js') }}"></script>

<!-- Import Content Blocks -->
<script src="{{ url_for('static', filename='js/content-blocks/base-content-block.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-blocks/route-test-block.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-blocks/response-display-block.js') }}"></script>

<!-- Import Main Application -->
<script src="{{ url_for('static', filename='js/api-test-app.js') }}"></script>

<script>
// Initialize the API Test App
window.apiTestApp = new APITestApp();

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ DOM loaded, initializing APITestApp...');
    
    // Give a short delay to ensure all scripts are loaded
    setTimeout(() => {
        window.apiTestApp.initialize().catch(error => {
            console.error('âŒ Failed to initialize APITestApp:', error);
            
            // Show error in UI
            const containers = ['routeTestContainer', 'responseDisplayContainer'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>Initialization Error</h6>
                            <p>Failed to initialize API Test application:</p>
                            <code>${error.message}</code>
                            <hr>
                            <button class="btn btn-outline-danger btn-sm" onclick="location.reload()">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            });
        });
    }, 200);
});

// Global debug functions
window.debugAPITest = () => window.apiTestApp.debug();
window.refreshAPITest = () => location.reload();

// Advanced testing functions (placeholder implementations)
window.performanceTest = function() {
    console.log('Performance test not yet implemented');
    alert('Performance testing functionality coming soon!');
};

window.stressTest = function() {
    console.log('Stress test not yet implemented');
    alert('Stress testing functionality coming soon!');
};

window.exportReport = function() {
    console.log('Export report not yet implemented');
    alert('Export functionality coming soon!');
};

// Handle route test completion events
document.addEventListener('routeTestComplete', function(event) {
    console.log('Route test completed:', event.detail);
    
    // Update response display
    if (window.responseDisplayBlock) {
        window.responseDisplayBlock.displayResponse(event.detail.result);
    }
});
</script>

{% endblock %}