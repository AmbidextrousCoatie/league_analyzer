{% extends "base.html" %}

{% block content %}
<!-- Existing player selection card -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Player Statistics</h4>
    </div>
    <div class="card-body">
        <div class="mb-4">
            <label for="playerInput" class="form-label">Select Player</label>
            <input 
                type="text" 
                class="form-control" 
                id="playerInput" 
                list="playerList" 
                placeholder="Type a player name..."
                autocomplete="off"
            >
            <datalist id="playerList">
                <!-- Players will be loaded here -->
            </datalist>
        </div>
        <div id="playerStats" class="mt-4">
            <!-- Basic player info will be here -->
        </div>
    </div>
</div>

<!-- Lifetime Stats Card -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Lifetime Statistics</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Overall Stats</h5>
                        <table class="table table-sm">
                            <tbody>
                                <tr><th>Total Games:</th><td id="lifetimeGames">-</td></tr>
                                <tr><th>Total Pins:</th><td id="lifetimePins">-</td></tr>
                                <tr><th>Average Score:</th><td id="lifetimeAvg">-</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Best Performance</h5>
                        <table class="table table-sm">
                            <tbody>
                                <tr><th>Highest Game:</th><td id="bestGame">-</td></tr>
                                <tr><th>Event:</th><td id="bestGameEvent">-</td></tr>
                                <tr><th>Date:</th><td id="bestGameDate">-</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Season Records</h5>
                        <table class="table table-sm">
                            <tbody>
                                <tr><th>Best Season:</th><td id="bestSeason">-</td></tr>
                                <tr><th>Most Improved:</th><td id="mostImproved">-</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Season Stats Card -->
<div class="card mb-4">
    <div class="card-header">
        <h4>Season Statistics</h4>
    </div>
    <div class="card-body">
        <div id="seasonStats">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Season</th>
                        <th>Games</th>
                        <th>Total Pins</th>
                        <th>Average</th>
                        <th>Dev. from Avg</th>
                        <th>vs Last Season</th>
                        <th>Best Game</th>
                        <th>Worst Game</th>
                    </tr>
                </thead>
                <tbody id="seasonStatsBody">
                    <!-- Season stats will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Existing trend chart card -->
<div class="card mt-4">
    <div class="card-header">
        <h5>Performance Trend</h5>
    </div>
    <div class="card-body">
        <canvas id="trendChart" height="300"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const playerInput = document.getElementById('playerInput');
    const playerList = document.getElementById('playerList');
    
    // Parse URL parameters
    function parseUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
            player_name: params.get('player_name'),
            database: params.get('database')
        };
    }
    
    // Load all players immediately
    fetchWithDatabase('{{ url_for("player.search_players") }}')
        .then(response => response.json())
        .then(players => {
            // Populate datalist with options
            playerList.innerHTML = players.map(player => 
                `<option value="${player.name}" data-id="${player.id}">`
            ).join('');
            
            // Check for URL parameters and auto-select player
            const urlParams = parseUrlParams();
            if (urlParams.player_name) {
                console.log('URL parameter found: player_name =', urlParams.player_name);
                
                // Find the player in the list
                const matchingPlayer = players.find(player => 
                    player.name === urlParams.player_name || player.id === urlParams.player_name
                );
                
                if (matchingPlayer) {
                    console.log('Found matching player:', matchingPlayer);
                    playerInput.value = matchingPlayer.name;
                    loadPlayerStats(matchingPlayer.name);
                } else {
                    console.warn('Player not found in database:', urlParams.player_name);
                    document.getElementById('playerStats').innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Player not found:</strong> "${urlParams.player_name}" was not found in the current database.
                        </div>
                    `;
                }
            }
        });

    // Handle player selection
    playerInput.addEventListener('change', function() {
        const selectedName = this.value;
        const option = Array.from(playerList.options).find(opt => opt.value === selectedName);
        
        if (option) {
            // Use the selected name directly since id and name are the same
            loadPlayerStats(selectedName);
        }
    });

    function loadPlayerStats(playerName) {
        console.log("loadPlayerStats: " + playerName);
        fetchWithDatabase(`{{ url_for("player.get_lifetime_stats") }}?player_name=${encodeURIComponent(playerName)}`)
            .then(response => response.json())
            .then(data => {
                // Check if data is null or missing required properties
                if (!data || !data.lifetime || !data.seasons) {
                    console.error('Invalid or missing player data:', data);
                    // Display error message to user
                    document.getElementById('playerStats').innerHTML = `
                        <div class="alert alert-warning">
                            <strong>No data available</strong> for player "${playerName}" in the selected database.
                        </div>
                    `;
                    // Clear other sections
                    document.getElementById('lifetimeGames').textContent = '-';
                    document.getElementById('lifetimePins').textContent = '-';
                    document.getElementById('lifetimeAvg').textContent = '-';
                    document.getElementById('bestGame').textContent = '-';
                    document.getElementById('bestGameEvent').textContent = '-';
                    document.getElementById('bestGameDate').textContent = '-';
                    document.getElementById('bestSeason').textContent = '-';
                    document.getElementById('mostImproved').textContent = '-';
                    document.getElementById('seasonStatsBody').innerHTML = '';
                    return;
                }
                
                displayLifetimeStats(data.lifetime);
                displaySeasonStats(data.seasons);
                updateTrendChart(data);  // We'll keep the existing chart functionality
            })
            .catch(error => {
                console.error('Error loading player stats:', error);
                document.getElementById('playerStats').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading data</strong> for player "${playerName}": ${error.message}
                    </div>
                `;
            });
    }

    function displayLifetimeStats(stats) {
        // Update lifetime stats card with null checks
        document.getElementById('lifetimeGames').textContent = stats.total_games || '-';
        document.getElementById('lifetimePins').textContent = (stats.total_pins || 0).toLocaleString();
        document.getElementById('lifetimeAvg').textContent = (stats.average_score || 0).toFixed(2);
        
        // Best game info with null checks
        if (stats.best_game) {
            document.getElementById('bestGame').textContent = stats.best_game.score || '-';
            document.getElementById('bestGameEvent').textContent = stats.best_game.event || '-';
            document.getElementById('bestGameDate').textContent = stats.best_game.date || '-';
        } else {
            document.getElementById('bestGame').textContent = '-';
            document.getElementById('bestGameEvent').textContent = '-';
            document.getElementById('bestGameDate').textContent = '-';
        }
        
        // Season records with null checks
        if (stats.best_season && stats.best_season.season) {
            document.getElementById('bestSeason').textContent = 
                `${stats.best_season.season} (${(stats.best_season.average || 0).toFixed(2)})`;
        } else {
            document.getElementById('bestSeason').textContent = '-';
        }
        
        // Handle null values for most improved
        if (stats.most_improved && stats.most_improved.season && stats.most_improved.improvement !== null) {
            document.getElementById('mostImproved').textContent = 
                `${stats.most_improved.season} (+${stats.most_improved.improvement.toFixed(2)})`;
        } else {
            document.getElementById('mostImproved').textContent = 'N/A';
        }
    }

    function displaySeasonStats(seasons) {
        const tbody = document.getElementById('seasonStatsBody');
        if (!seasons || !Array.isArray(seasons) || seasons.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No season data available</td></tr>';
            return;
        }
        
        tbody.innerHTML = seasons.map(season => `
            <tr>
                <td>${season.season || '-'}</td>
                <td>${season.games || 0}</td>
                <td>${(season.total_pins || 0).toLocaleString()}</td>
                <td>${(season.average || 0).toFixed(2)}</td>
                <td>${(season.dev_from_avg || 0) > 0 ? '+' : ''}${(season.dev_from_avg || 0).toFixed(2)}</td>
                <td>${season.vs_last_season !== null ? (season.vs_last_season > 0 ? '+' : '') + season.vs_last_season.toFixed(2) : '-'}</td>
                <td title="${season.best_game?.date || ''} - ${season.best_game?.event || ''}">${season.best_game?.score || '-'}</td>
                <td title="${season.worst_game?.date || ''} - ${season.worst_game?.event || ''}">${season.worst_game?.score || '-'}</td>
            </tr>
        `).join('');
    }

    function updateTrendChart(data) {
        const ctx = document.getElementById('trendChart');
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
            existingChart.destroy();
        }

        // Check if we have valid data for the chart
        if (!data || !data.seasons || !Array.isArray(data.seasons) || data.seasons.length === 0 || !data.lifetime) {
            console.warn('Insufficient data for trend chart:', data);
            ctx.style.display = 'none';
            return;
        }

        ctx.style.display = 'block';

        const chartData = {
            datasets: [
                {
                    label: 'Season Average',
                    data: data.seasons.map((season, i) => ({
                        x: season.season || `Season ${i}`,
                        y: season.average || 0,
                        r: (season.games || 0) / 5
                    })),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    pointStyle: 'circle'
                },
                {
                    label: 'Trend Line',
                    showInLegend: false,
                    data: data.seasons.map((season, i) => ({
                        x: season.season || `Season ${i}`,
                        y: season.average || 0
                    })),
                    type: 'line',
                    borderColor: 'rgba(54, 162, 235, 0.6)',
                    fill: false,
                    tension: 0.1,
                    showLine: true,
                    pointRadius: 0
                },
                {
                    label: 'All-Time Average',
                    data: data.seasons.map(season => ({
                        x: season.season || 'Unknown',
                        y: data.lifetime.average_score || 0
                    })),
                    type: 'line',
                    borderColor: 'rgba(128, 128, 128, 0.6)',
                    borderDash: [5, 5],
                    pointStyle: 'line',
                    fill: false,
                    tension: 0
                }
            ]
        };

        window.trendChart = new Chart(ctx, {
            type: 'bubble',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'category',
                        title: {
                            display: true,
                            text: 'Season'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Average Score'
                        },
                        beginAtZero: false
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataIndex = context.dataIndex;
                                if (context.dataset.label === 'Season Average') {
                                    return [
                                        `Average: ${(data.seasons[dataIndex]?.average || 0).toFixed(1)}`,
                                        `Games: ${data.seasons[dataIndex]?.games || 0}`
                                    ];
                                }
                                return `All-Time Average: ${(data.lifetime?.average_score || 0).toFixed(1)}`;
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }
});
</script>
{% endblock %} 