{% extends "base.html" %}

{% block content %}
    {% include "components/tables.html" %}
    {% include "components/charts.html" %}

<div class="container-fluid">
    <!-- Selection Area -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>League Statistics</h4>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <h5>Season</h5>
                    <div id="buttonsSeason" class="btn-group-horizontal w-100">
                        <!-- Seasons will be inserted here -->
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>League</h5>
                    <div id="buttonsLeague" class="btn-group-horizontal w-100">
                        <!-- Leagues will be inserted here -->
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>Week</h5>
                    <div id="buttonsWeek" class="btn-group-horizontal w-100">
                        <!-- Weeks will be inserted here -->
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h5>Team</h5>
                    <div id="buttonsTeam" class="btn-group-horizontal w-100">
                        <!-- Teams will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- League History Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Season Overview</h5>
        </div>
        <!-- Message Area -->
        <div id="selectionMessage" class="alert alert-danger" style="font-size: 1.5rem; font-weight: bold;">
            Please select a combination of Season and League.
        </div>

        <!-- Table Area -->
        <div id="leagueTableHistory" style="display: none">
            <!-- Table will be inserted here -->
        </div>

        <div class="card-body">
            <!-- Position Charts -->
            <div class="row">
                <!-- Positions over the course of the season -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Position in Season Progress</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamPositionCumulated" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>            
                <!-- Points over the course of the season -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Points in Season Progress</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamPointsCumulated" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Shared Legend -->
            <div class="row mt-3">
                <div class="col-12">
                    <div id="sharedLegend" class="d-flex justify-content-center flex-wrap">
                        <!-- Legend will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            <!-- Points Charts -->
            <div class="row">
                <!-- Points per Week Chart -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Points per Match Day</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamPointsWeekly" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <!-- Position per Week Chart -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Position per Match Day</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamPositionWeekly" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Shared Legend -->
            <div class="row mt-3">
                <div class="col-12">
                    <div id="sharedLegendMiddle" class="d-flex justify-content-center flex-wrap">
                        <!-- Legend will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            <!-- misc Charts -->
            <div class="row">
                <!-- Average per Week Chart -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Average per Match Day</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamAverageScoreWeekly" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <!-- Points vs Average -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Points vs. Average</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="chartTeamPointsVsAverage"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>  

    <!-- League Results - Match Day -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>League Results - Match Day</h5>
        </div>
        <div class="card-body">
            <!-- Message Area -->
            <div id="weekMessage" class="alert alert-info">
                Please select a match day.
            </div>
        
            <!-- Content Area -->
            <div class="row">
                <div class="col-md-8">
                    <div id="tableLeagueWeek" style="display: none">
                        <!-- Table will be dynamically inserted here -->
                    </div>
                </div>
                <div class="col-md-4">
                    <div id="honorScores" class="card">
                        <div class="card-header">
                            <h5>Honor Scores</h5>
                        </div>
                        <div class="card-body">
                            <!-- Make sure these IDs exist -->
                            <div class="mb-3">
                                <h6>Top Individual Scores</h6>
                                <div id="individualScores"></div>
                            </div>
                            <div class="mb-3">
                                <h6>Top Team Scores</h6>
                                <div id="teamScores"></div>
                            </div>
                            <div class="mb-3">
                                <h6>Best Individual Averages</h6>
                                <div id="individualAverages"></div>
                            </div>
                            <div class="mb-3">
                                <h6>Best Team Averages</h6>
                                <div id="teamAverages"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Details Section -->
        <div class="card-body">
            <div class="card">
                <div class="card-header">
                    <h5>Score Sheet for Selected Team</h5>
                    <div id="teamDetailsMetadata" class="text-muted small"></div>
                </div>
                <div class="card-body">
                    <div id="teamTableWeekDetails">
                        <!-- Team table will be dynamically inserted here -->
                        <div class="alert alert-info">Please select a team to display the score sheet.</div>
                    </div>
                </div>
            </div>  
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script>

let positionChart = null;

function updateSharedLegend(teams) {
    const legendHtml = teams.map(team => `
        <div class="mx-3 mb-2 d-flex align-items-center">
            <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${getTeamColor(team)}; margin-right: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                
            </div>
            <span>${team}</span>
        </div>
    `).join('');
    
    document.getElementById('sharedLegend').innerHTML = legendHtml;
    document.getElementById('sharedLegendMiddle').innerHTML = legendHtml;
}

function updatePositionChart() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="week"]:checked')?.value;
    
    if (selectedSeason && selectedLeague) {
        fetch(`/league/get_position_history?season=${selectedSeason}&league=${selectedLeague}&week=${currentWeek}&depth=${currentWeek}`)
            .then(response => response.json())
            .then(data => {
                // Destroy existing chart if it exists
                if (positionChart) positionChart.destroy();
                
                // Updated color palette
                const colors = [
                    '#28255c', '#592a6b', '#882c70', '#b4306b',
                    '#d8405e', '#f25b4a', '#ff7f30', '#ffa600'
                ];
                
                // Assign colors to teams
                const teamColors = data.teams.reduce((acc, team, index) => {
                    acc[team] = colors[index % colors.length];
                    return acc;
                }, {});
                
                // Create new chart
                positionChart = new Chart(document.getElementById('positionChart'), {
                    type: 'line',
                    data: {
                        labels: data.weeks,
                        datasets: data.teams.map(team => ({
                            label: team,
                            data: data.data
                                .filter(d => d.team === team)
                                .sort((a, b) => a.week - b.week)
                                .map(d => d.position),
                            borderColor: teamColors[team],
                            backgroundColor: teamColors[team],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            pointStyle: 'circle',
                        }))
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                reverse: true,
                                min: 0.5,
                                max: data.teams.length + 0.5,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : '';
                                    }
                                },
                                grid: {
                                    color: '#f0f0f0',
                                    offset: false,
                                    drawTicks: true,
                                    drawOnChartArea: true,
                                    // Align grid with integer positions
                                    z: 1,
                                    tickOffset: 0,
                                    tickLength: 0
                                },
                                afterFit: function(scaleInstance) {
                                    // Ensure grid lines align with positions
                                    scaleInstance.options.grid.offset = false;
                                },
                                afterDataLimits: (scale) => {
                                    // Align grid with integer positions
                                    scale.min = 0.5;
                                    scale.max = data.teams.length + 0.5;
                                },
                                title: { 
                                    display: true, 
                                    text: 'Position',
                                    font: { weight: 'bold' },
                                    padding: { top: 10, bottom: 10 }
                                }
                            },
                            x: {
                                grid: {
                                    drawTicks: true
                                },
                                title: {
                                    display: true,
                                    text: 'Match Day',
                                    font: { weight: 'bold' },
                                    padding: { top: 10, bottom: 10 }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const team = context.dataset.label;
                                        const position = context.parsed.y;
                                        const points = data.data.find(d => 
                                            d.team === team && d.week === context.parsed.x
                                        ).points;
                                        return `${team}: Position ${position} (${points} pts)`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 10
                                }
                            }
                        },
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error:', error));
    }
}

function updateTableTeamDetails() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    const selectedTeam = document.querySelector('input[name="team"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague || !selectedWeek || !selectedTeam) {
        return;
    }
    
    // Update header
    document.getElementById('teamDetailsMetadata').innerHTML = `${selectedTeam} - Match Day ${selectedWeek}`;
    
    // Show loading state
    document.getElementById('teamTableWeekDetails').innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    // Fetch team details
    fetch(`/league/get_team_week_details?season=${selectedSeason}&league=${selectedLeague}&week=${selectedWeek}&team=${selectedTeam}`)
        .then(response => response.json())
        .then(data => {
            // Process and display the data
            const content = document.getElementById('teamTableWeekDetails');
            
            if (data.config && data.config.length > 0) {
                let html = '<div class="list-group">';
                
                data.config.forEach(match => {
                    html += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>${match.player}</strong>
                                <span class="badge bg-primary rounded-pill">${match.score}</span>
                            </div>
                            <div class="small text-muted mt-1">vs. ${match.opponent}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = '<div class="alert alert-info">No details available for this team and week.</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('teamTableWeekDetails').innerHTML = '<div class="alert alert-danger">Error loading team details.</div>';
        });
}

function updateTablePosition(data) {
    const table = document.getElementById('positionHistoryTable');
    
    // Update headers
    const headerRow = table.querySelector('thead tr');
    headerRow.innerHTML = '<th>Team</th>';
    data.weeks.forEach(week => {
        headerRow.innerHTML += `
            <th colspan="2">Week ${week}</th>
        `;
    });
    
    // Add subheader row for Points/Average
    const subheaderRow = document.createElement('tr');
    subheaderRow.innerHTML = '<th></th>';  // Empty cell for team name
    data.weeks.forEach(() => {
        subheaderRow.innerHTML += `
            <th>Points</th>
            <th>Average</th>
        `;
    });
    table.querySelector('thead').appendChild(subheaderRow);
    
    // Update body
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    data.data.forEach(teamData => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${teamData.team}</td>`;
        
        teamData.weeks.forEach(week => {
            row.innerHTML += `
                <td>${week.points.toFixed(1)}</td>
                <td>${week.average.toFixed(2)}</td>
            `;
        });
        
        tbody.appendChild(row);
    });
}

function updateSectionLeagueStandings() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) {
        console.log("Missing required selection");
        return;
    }

    fetch(`/league/get_league_history?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            createTableBootstrap3('leagueTableHistory', data);
        })
        .catch(error => console.error('Error:', error));
}

function updateTableLeagueWeek() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) {
        return;
    }
    
    if (!selectedWeek) {
        // Show message when no week is selected
        const messageArea = document.getElementById('weekMessage');
        const standingsTable = document.getElementById('tableLeagueWeek');
        
        if (messageArea) {
            messageArea.style.display = 'block';
            messageArea.innerHTML = 'Please select a match day.';
        }
        if (standingsTable) standingsTable.style.display = 'none';
        return;
    }
    
    // Show the table and hide the message
    const messageArea = document.getElementById('weekMessage');
    const standingsTable = document.getElementById('tableLeagueWeek');
    
    if (messageArea) messageArea.style.display = 'none';
    if (standingsTable) standingsTable.style.display = 'block';
    
    // Fetch and display table
    fetchAndRenderTable('tableLeagueWeek', '/league/get_league_week_table', {
        season: selectedSeason,
        league: selectedLeague,
        week: selectedWeek
    });
}

function updateTableLeagueHistory() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) {
        document.getElementById('selectionMessage').style.display = 'block';
        document.getElementById('leagueTableHistory').style.display = 'none';
        return;
    }
    
    document.getElementById('selectionMessage').style.display = 'none';
    document.getElementById('leagueTableHistory').style.display = 'block';
    
    // Fetch and display table
    fetchAndRenderTable('leagueTableHistory', '/league/get_league_history', {
        season: selectedSeason,
        league: selectedLeague
    });
}

// Initialize the page
function initializePage() {
    console.log("Initializing page...");
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const selectedSeason = urlParams.get('season');
    const selectedLeague = urlParams.get('league');
    const selectedWeek = urlParams.get('week');
    const selectedTeam = urlParams.get('team');
    
    console.log("URL parameters:", { season: selectedSeason, league: selectedLeague, week: selectedWeek, team: selectedTeam });

    // Function to update all content
    function updateAllContent() {
        handleSelectionChange();
        updateChartsLeague();
        updateTableLeagueWeek();
        handleWeekTeamSelection();
        updateHonorScores();
    }

    // Function to update week-specific content
    function updateWeekContent() {
        // Show the table and hide the message
        const messageArea = document.getElementById('weekMessage');
        const standingsTable = document.getElementById('tableLeagueWeek');
        
        if (messageArea) messageArea.style.display = 'none';
        if (standingsTable) standingsTable.style.display = 'block';
        
        // Update tables and scores
        updateTableLeagueWeek();
        updateHonorScores();
    }

    // Function to load leagues
    function loadLeagues() {
        fetch('/league/get_available_leagues')
            .then(response => response.json())
            .then(leagues => {
                const buttonsLeague = leagues.map(league => `
                    <input type="radio" class="btn-check" name="league" id="league_${league}" 
                           value="${league}" ${league === selectedLeague ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="league_${league}">${league}</label>
                `).join('');
                document.getElementById('buttonsLeague').innerHTML = buttonsLeague;
                
                if (selectedLeague && leagues.includes(selectedLeague)) {
                    // First update available options
                    updateAvailableOptions();
                    
                    // Then fetch weeks specifically for selected season and league
                    fetch(`/league/get_available_weeks?season=${selectedSeason}&league=${selectedLeague}`)
                        .then(response => response.json())
                        .then(weeks => {
                            const weekButtons = weeks.map(week => `
                                <input type="radio" class="btn-check" name="week" id="week_${week}" 
                                       value="${week}" ${week.toString() === selectedWeek ? 'checked' : ''}>
                                <label class="btn btn-outline-primary" for="week_${week}">${week}</label>
                            `).join('');
                            document.getElementById('buttonsWeek').innerHTML = weekButtons;
                            
                            // After weeks are loaded, update all content
                            if (selectedWeek && weeks.includes(parseInt(selectedWeek))) {
                                updateAllContent();
                                updateWeekContent();
                            }
                        })
                        .catch(error => {
                            console.error('Error loading weeks:', error);
                            document.getElementById('buttonsWeek').innerHTML = `
                                <div class="alert alert-danger">
                                    <strong>Error loading weeks:</strong> ${error.message || 'Unknown error'}
                                </div>
                            `;
                        });
                    
                    // Fetch teams specifically for selected season and league
                    fetch(`/league/get_available_teams?season=${selectedSeason}&league=${selectedLeague}`)
                        .then(response => response.json())
                        .then(teams => {
                            const teamButtons = teams.map(team => `
                                <input type="radio" class="btn-check" name="team" id="team_${team.replace(/\s+/g, '_')}" 
                                       value="${team}" ${team === selectedTeam ? 'checked' : ''}>
                                <label class="btn btn-outline-primary" for="team_${team.replace(/\s+/g, '_')}">${team}</label>
                            `).join('');
                            document.getElementById('buttonsTeam').innerHTML = teamButtons;
                            
                            // Select the team if it was in URL
                            if (selectedTeam && teams.includes(selectedTeam)) {
                                const teamInput = document.querySelector(`input[name="team"][value="${selectedTeam}"]`);
                                if (teamInput) {
                                    teamInput.checked = true;
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error loading teams:', error);
                            document.getElementById('buttonsTeam').innerHTML = `
                                <div class="alert alert-danger">
                                    <strong>Error loading teams:</strong> ${error.message || 'Unknown error'}
                                </div>
                            `;
                        });
                }
            })
            .catch(error => {
                console.error('Error loading leagues:', error);
                document.getElementById('buttonsLeague').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading leagues:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });
    }

    // Load available seasons
    fetch('/league/get_available_seasons')
        .then(response => response.json())
        .then(seasons => {
            const buttonsSeason = seasons.map(season => `
                <input type="radio" class="btn-check" name="season" id="season_${season}" 
                       value="${season}" ${season === selectedSeason ? 'checked' : ''}>
                <label class="btn btn-outline-primary" for="season_${season}">${season}</label>
            `).join('');
            document.getElementById('buttonsSeason').innerHTML = buttonsSeason;
            
            // Always load leagues, regardless of whether a season is selected
            loadLeagues();
            
            // If we have a selected season, select it
            if (selectedSeason && seasons.includes(selectedSeason)) {
                const seasonInput = document.querySelector(`input[name="season"][value="${selectedSeason}"]`);
                if (seasonInput) {
                    seasonInput.checked = true;
                }
            }
        })
        .catch(error => {
            console.error('Error loading seasons:', error);
            document.getElementById('buttonsSeason').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Error loading seasons:</strong> ${error.message || 'Unknown error'}
                </div>
            `;
        });

    // Add event listeners for future changes
    document.addEventListener('change', event => {
        console.log('🔍 Change event detected:', event.target.name, '=', event.target.value);
        
        if (event.target.name === 'season' || event.target.name === 'league') {
            console.log('🔍 Handling season/league change');
            handleSelectionChange();
            updateAvailableOptions();
            updateChartsLeague();
            // Also update week-specific content when season/league changes
            updateTableLeagueWeek();
            updateHonorScores();
        }
        if (event.target.name === 'week' || event.target.name === 'team') {
            console.log('🔍 Handling week/team change');
            updateTableTeamDetails();
            updateWeekContent();
            handleWeekTeamSelection();
        }
    });
}

// Handle selection changes
function handleSelectionChange() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    // Update URL parameters
    const url = new URL(window.location);
    if (selectedSeason) url.searchParams.set('season', selectedSeason);
    if (selectedLeague) url.searchParams.set('league', selectedLeague);
    window.history.pushState({}, '', url);
    
    const messageArea = document.getElementById('selectionMessage');
    const tableArea = document.getElementById('leagueTableHistory');
    
    if (selectedSeason && selectedLeague) {
        messageArea.style.display = 'none';
        tableArea.style.display = 'block';
        updateSectionLeagueStandings();
        updateChartsLeague();
        // Also update week-specific content when season/league changes
        updateTableLeagueWeek();
        updateHonorScores();
        
    } else {
        messageArea.style.display = 'block';
        tableArea.style.display = 'none';
    }
}

// Update available weeks and teams when season/league selection changes
function updateAvailableOptions() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    const selectedTeam = document.querySelector('input[name="team"]:checked')?.value;

    console.log("Updating available options for:", {
        season: selectedSeason,
        league: selectedLeague
    });

    if (selectedSeason && selectedLeague) {
        // Update available weeks
        fetch(`/league/get_available_weeks?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(weeks => {
                const weekButtons = weeks.map(week => `
                    <input type="radio" class="btn-check" name="week" id="week_${week}" 
                           value="${week}" ${week.toString() === selectedWeek ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="week_${week}">${week}</label>
                `).join('');
                document.getElementById('buttonsWeek').innerHTML = weekButtons;
                
                // Select first week by default if none selected
                if (!selectedWeek && weeks.length > 0) {
                    const firstWeekInput = document.querySelector(`input[name="week"][value="${weeks[0]}"]`);
                    if (firstWeekInput) {
                        firstWeekInput.checked = true;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading weeks:', error);
                document.getElementById('buttonsWeek').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading weeks:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });

        // Update available teams
        fetch(`/league/get_available_teams?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(teams => {
                const teamButtons = teams.map(team => `
                    <input type="radio" class="btn-check" name="team" id="team_${team.replace(/\s+/g, '_')}" 
                           value="${team}" ${team === selectedTeam ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="team_${team.replace(/\s+/g, '_')}">${team}</label>
                `).join('');
                document.getElementById('buttonsTeam').innerHTML = teamButtons;
                
                // Select first team by default if none selected
                if (!selectedTeam && teams.length > 0) {
                    const firstTeamInput = document.querySelector(`input[name="team"][value="${teams[0]}"]`);
                    if (firstTeamInput) {
                        firstTeamInput.checked = true;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading teams:', error);
                document.getElementById('buttonsTeam').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading teams:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });
    } else {
        // Clear buttons if no season/league selected
        document.getElementById('buttonsWeek').innerHTML = '';
        document.getElementById('buttonsTeam').innerHTML = '';
    }
}

// Handle week/team selection changes
function handleWeekTeamSelection() {
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    const selectedTeam = document.querySelector('input[name="team"]:checked')?.value;
    
    // Update URL parameters
    const url = new URL(window.location);
    if (selectedWeek) url.searchParams.set('week', selectedWeek);
    if (selectedTeam) url.searchParams.set('team', selectedTeam);
    window.history.pushState({}, '', url);
    
    const messageArea = document.getElementById('weekMessage');
    const standingsTable = document.getElementById('tableLeagueWeek');
    
    if (selectedWeek) {
        messageArea.style.display = 'none';
        standingsTable.style.display = 'block';
        
        updateTableLeagueWeek();

        
        if (selectedTeam) {
            updateTableTeamDetails();
        }
    } else {
        messageArea.style.display = 'block';
        standingsTable.style.display = 'none';
    }
}

function updateHonorScores() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) {
        return;
    }
    
    if (!selectedWeek) {
        // Clear honor scores when no week is selected
        document.getElementById('individualScores').innerHTML = '<div class="text-muted">Please select a match day.</div>';
        document.getElementById('teamScores').innerHTML = '<div class="text-muted">Please select a match day.</div>';
        document.getElementById('individualAverages').innerHTML = '<div class="text-muted">Please select a match day.</div>';
        document.getElementById('teamAverages').innerHTML = '<div class="text-muted">Please select a match day.</div>';
        return;
    }
    
    fetch(`/league/get_honor_scores?season=${selectedSeason}&league=${selectedLeague}&week=${selectedWeek}`)
        .then(response => response.json())
        .then(data => {
            // Individual Scores
            document.getElementById('individualScores').innerHTML = data.individual_scores
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.player}</span>
                    <span class="fw-bold">${item.score}</span>
                </div>`).join('');
            
            // Team Scores
            document.getElementById('teamScores').innerHTML = data.team_scores
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.team}</span>
                    <span class="fw-bold">${item.score}</span>
                </div>`).join('');
            
            // Individual Averages
            document.getElementById('individualAverages').innerHTML = data.individual_averages
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.player}</span>
                    <span class="fw-bold">${item.average.toFixed(1)}</span>
                </div>`).join('');
            
            // Team Averages
            document.getElementById('teamAverages').innerHTML = data.team_averages
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.team}</span>
                    <span class="fw-bold">${item.average.toFixed(1)}</span>
                </div>`).join('');
        })
        .catch(error => console.error('Error:', error));
}

function updateTeamAveragesChart() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) return;

    fetch(`/league/get_team_averages?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('teamAveragesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.teamAveragesChart instanceof Chart) {
                window.teamAveragesChart.destroy();
            }
            
            window.teamAveragesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => `Week ${d.week}`),
                    datasets: [{
                        label: 'Average Points',
                        data: data.map(d => d.average),
                        borderColor: '#6FAED4',
                        backgroundColor: '#6FAED4',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Average Points for ${selectedTeam}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
}

function updateChartsLeague() {
    console.log('🔍 updateChartsLeague function called');
    
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    console.log('🔍 Selected season/league:', selectedSeason, selectedLeague);
    
    if (!selectedSeason || !selectedLeague) {
        console.log('🔍 Missing season or league, returning early');
        return;
    }
    
    // Fetch and create position charts
    fetch(`/league/get_team_positions?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            // Create labels based on number of weeks
            const numWeeks = Object.values(data.data)[0].length;
            const labels = Array.from({length: numWeeks}, (_, i) => `Match Day ${i + 1}`);

            // Create weekly positions chart
           createLineChart(
                data.data,
                data.sorted_by_total,
                'chartTeamPositionWeekly',
                'Position per Match Day',
                labels, 
                false,
                'exact'
            );

            // Create cumulative positions chart
            createLineChart(
                data.data,
                data.sorted_by_total,
                'chartTeamPositionCumulated',
                'ERROR: Position in Season Progress',
                labels,
                false,
                'exact'
            );

            updateSharedLegend(data.sorted_by_total);
        })
        .catch(error => {
            console.error('Error loading team positions:', error);
        });

    // Fetch and create points charts
    fetch(`/league/get_team_points?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            // Create labels based on number of weeks
            const numWeeks = Object.values(data.data)[0].length;
            const labels = Array.from({length: numWeeks}, (_, i) => `Match Day ${i + 1}`);

            createScatterChartMultiAxis(
                data.data,
                data.sorted_by_total,
                'chartTeamPointsWeekly',
                'Points per Match Day',
                labels
            );

            // Create cumulative positions chart
            createLineChart(
                data.data_accumulated,
                data.sorted_by_total,
                'chartTeamPointsCumulated',
                'Points in Season Progress',
                labels,
                false
            );
        })
        .catch(error => {
            console.error('Error loading team points:', error);
        });

            fetch(`/league/get_team_averages?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            console.log('=== TEAM AVERAGES DEBUG ===');
            console.log('Data structure:', {
                hasData: !!data.data,
                dataKeys: data.data ? Object.keys(data.data) : 'no data',
                hasOrder: !!data.sorted_by_total,
                orderLength: data.sorted_by_total ? data.sorted_by_total.length : 'no order'
            });
            
            const chartContainer = document.getElementById('chartTeamAverageScoreWeekly');
            if (!chartContainer) {
                console.error('❌ Chart container not found!');
                return;
            }
            
            const numWeeks = Object.values(data.data)[0].length;
            const labels = Array.from({length: numWeeks}, (_, i) => `Match Day ${i + 1}`);
            
            console.log('Creating chart with weeks:', numWeeks, 'labels:', labels.length);

            try {
                createLineChart(
                    data.data,
                    data.sorted_by_total,
                    'chartTeamAverageScoreWeekly',
                    'Average per Match Day',
                    labels,
                    false,
                    'auto'
                );
                
                console.log('✅ Team averages chart created successfully');
            } catch (error) {
                console.error('❌ Error creating team averages chart:', error);
            }
            console.log('=== END TEAM AVERAGES DEBUG ===');
        })
        .catch(error => {
            console.error('❌ Error loading team averages:', error);
        });

    fetch(`/league/get_team_points_vs_average?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            axis_labels = ['Points', 'Average']
            createScatterChart_vanilla(
                data,
                'chartTeamPointsVsAverage',
                'Points vs. Average',
                axis_labels
            );
        })
        .catch(error => {
            console.error('Error loading team points vs average:', error);
        });
}

// Initial load
document.addEventListener('DOMContentLoaded', initializePage);
</script>

{% endblock %}