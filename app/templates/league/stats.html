{% extends "base.html" %}

{% block content %}
    {% include "components/tables.html" %}
    {% include "components/charts.html" %}


<div class="card">
    <div class="card-header">
        <h4>League Statistics</h4>
    </div>
    <div class="card-body">
        <!-- Selection Area -->
        <div class="row mb-3">
            <div class="col-md-6">
                <h5>Saison</h5>
                <div id="buttonsSeason" class="btn-group-horizontalw-100">
                    <!-- Seasons will be inserted here -->
                </div>
            </div>
            <div class="col-md-6">
                <h5>Liga</h5>
                <div id="buttonsLeague" class="btn-group-horizontal w-100">
                    <!-- Leagues will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- League History Table -->
<div class="card">
    <div class="card-header">
        <h5>Saisonübersicht</h5>
    </div>
    <!-- Message Area -->
    <div id="selectionMessage" class="alert alert-info">
        Bitte wählen Sie eine Kombintation aus Saison und Liga.
    </div>

    <!-- Table Area -->
    <div id="leagueTableHistory" style="display: none">
        <!-- Table will be inserted here -->
    </div>

    <div class="card-body">
        <div class="row">

            <!-- Positions over the course of the season -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Platzierung im Saisonverlauf</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTeamPositionCumulated"></canvas>
                    </div>
                </div>
            </div>            
            <!-- Cumulative Points Chart -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Punkte im Saisonverlauf</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTeamPointsCumulated"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Shared Legend -->
        <div class="row mt-3">
            <div class="col-12">
                <div id="sharedLegend" class="d-flex justify-content-center flex-wrap">
                    <!-- Legend will be dynamically inserted here -->
                </div>
            </div>
        </div>
        <!-- After your existing charts and shared legend -->
        <div class="row">
            <!-- Points per Week Chart -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Punkte pro Spieltag</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTeamPointsWeekly"></canvas>
                    </div>
                </div>
            </div>
            <!-- Position per Week Chart -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Platzierung pro Spieltag</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTeamPositionWeekly"></canvas>
                    </div>
                </div>
            </div>
            

        </div>
    </div>
</div>  
<!---/div-->

<!--//////////////////////////////////////////////////////////////////////////-->
<!--//////////////////////////////////////////////////////////////////////////-->   

    <div class="card">
       <div class="card-header">
            <h5>Ligaergebnisse - Spieltag</h5>
        </div>
        <div class="card-body">
            <!-- Selection Area -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <h5>Week</h5>
                    <div id="buttonsWeek" class="btn-group-horizontal w-100">
                        <!-- Weeks will be inserted here -->
                    </div>
                </div>
            </div>
        
        <div id="weekHeader" class="card-header">
            <h5>Ergebnisse für Spieltag ###</h5>
        </div>
        <div class="card-body">
            <!-- Selection Area -->
        
            <!-- Message Area -->
            <div id="weekMessage" class="alert alert-info">
                Bitte wählen Sie einen Spieltag und ein Team aus.
            </div>
        
            <!-- Content Area -->
            <div class="row">
                <div class="col-md-8">
                    <div id="tableLeagueWeek" style="display: none">
                        <!-- Table will be dynamically inserted here -->
                    </div>
                </div>
                <div class="col-md-4">
                    <div id="honorScores" class="card">
                        <div class="card-header">
                            <h5>Honor Scores</h5>
                        </div>
                        <div class="card-body">
                            <!-- Make sure these IDs exist -->
                            <div class="mb-3">
                                <h6>Top Individual Scores</h6>
                                <div id="individualScores"></div>
                            </div>
                            <div class="mb-3">
                                <h6>Top Team Scores</h6>
                                <div id="teamScores"></div>
                            </div>
                            <div class="mb-3">
                                <h6>Best Individual Averages</h6>
                                <div id="individualAverages"></div>
                            </div>
                            <div class="mb-3">
                                <h6>Best Team Averages</h6>
                                <div id="teamAverages"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Selection -->
<div class="mb-2">

    <!-- League Team Table -->
    <div class="card">
        <div class="row mb-3">
            <div class="col-md-8">
                <h5>Team</h5>
                <div id="buttonsTeam" class="btn-group-horizontal w-100">
                    <!-- Teams will be inserted here -->
                </div>
            </div>
        </div>
        <div class="card-header">
            <h5>Spielzettel für Aschaffenburg 55</h5>
            <div id="teamDetailsMetadata" class="text-muted small"></div>
        </div>
        <div class="card-body">
            <div id="teamTableWeekDetails">
                <!-- Team table will be dynamically inserted here -->
                <div class="alert alert-info">Bitte wählen Sie eine Saison, eine Liga und einen Spieltag aus um den Spielzettel für ein Team anzeigen zu können.</div>
            </div>
        </div>
    </div>  
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

let positionChart = null;


function updateSharedLegend(teams) {
    const legendHtml = teams.map(team => `
        <div class="mx-3 mb-2 d-flex align-items-center">
            <div style="width: 20px; height: 20px; background-color: ${getTeamColor(team)}; margin-right: 8px;"></div>
            <span>${team}</span>
        </div>
    `).join('');
    
    document.getElementById('sharedLegend').innerHTML = legendHtml;
}

function updatePositionChart() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="week"]:checked')?.value;
    
    if (selectedSeason && selectedLeague) {
        fetch(`/league/get_position_history?season=${selectedSeason}&league=${selectedLeague}&week=${currentWeek}&depth=${currentWeek}`)
            .then(response => response.json())
            .then(data => {
                // Destroy existing chart if it exists
                if (positionChart) positionChart.destroy();
                
                // Updated color palette
                const colors = [
                    '#28255c', '#592a6b', '#882c70', '#b4306b',
                    '#d8405e', '#f25b4a', '#ff7f30', '#ffa600'
                ];
                
                // Assign colors to teams
                const teamColors = data.teams.reduce((acc, team, index) => {
                    acc[team] = colors[index % colors.length];
                    return acc;
                }, {});
                
                // Create new chart
                positionChart = new Chart(document.getElementById('positionChart'), {
                    type: 'line',
                    data: {
                        labels: data.weeks,
                        datasets: data.teams.map(team => ({
                            label: team,
                            data: data.data
                                .filter(d => d.team === team)
                                .sort((a, b) => a.week - b.week)
                                .map(d => d.position),
                            borderColor: teamColors[team],
                            backgroundColor: teamColors[team],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            pointStyle: 'circle',
                        }))
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                reverse: true,
                                min: 0.5,
                                max: data.teams.length + 0.5,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : '';
                                    }
                                },
                                grid: {
                                    color: '#f0f0f0',
                                    offset: false,
                                    drawTicks: true,
                                    drawOnChartArea: true,
                                    // Align grid with integer positions
                                    z: 1,
                                    tickOffset: 0,
                                    tickLength: 0
                                },
                                afterFit: function(scaleInstance) {
                                    // Ensure grid lines align with positions
                                    scaleInstance.options.grid.offset = false;
                                },
                                afterDataLimits: (scale) => {
                                    // Align grid with integer positions
                                    scale.min = 0.5;
                                    scale.max = data.teams.length + 0.5;
                                },
                                title: { 
                                    display: true, 
                                    text: 'Position',
                                    font: { weight: 'bold' },
                                    padding: { top: 10, bottom: 10 }
                                }
                            },
                            x: {
                                grid: {
                                    drawTicks: true
                                },
                                title: {
                                    display: true,
                                    text: 'Match Day',
                                    font: { weight: 'bold' },
                                    padding: { top: 10, bottom: 10 }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const team = context.dataset.label;
                                        const position = context.parsed.y;
                                        const points = data.data.find(d => 
                                            d.team === team && d.week === context.parsed.x
                                        ).points;
                                        return `${team}: Position ${position} (${points} pts)`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 10
                                }
                            }
                        },
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error:', error));
    }
}



function updateTableTeamDetails() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="week"]:checked')?.value;
    const team = document.querySelector('input[name="team"]:checked')?.value;

    console.log("Updating team week details...");
    console.log("Season:", selectedSeason);
    console.log("League:", selectedLeague);
    console.log("Week:", currentWeek);
    console.log("Team:", team);

    if (!selectedSeason || !selectedLeague || !currentWeek) {
        console.log("Missing required selection");
        document.getElementById('teamTableWeekDetails').innerHTML = 
            '<div class="alert alert-warning">Please select season, league, and match day</div>';
        return;
    }


    document.querySelector('#teamTableWeekDetails').closest('.card')
        .querySelector('.card-header h5').textContent = `Results for Team ${team} in week ${currentWeek}`;
    

    document.getElementById('teamTableWeekDetails').innerHTML = 
        '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
    
    fetch(`/league/get_team_week_details?season=${selectedSeason}&league=${selectedLeague}&team=${team}&week=${currentWeek}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(response => {
            console.log("Received data:", response);
            
            if (!response.config) {
                throw new Error('Invalid response structure: missing config');
            }

            // Transform the data into array format
            const transformedData = response.config.data.map(row => {
                // Create an array matching the column order
                return response.config.columns.map(col => row[col.key]);
            });

            const tableConfig = {
                id: 'teamTableWeekDetails',
                headerGroups: response.config.headerGroups,
                columns: response.config.columns,
                data: transformedData,  // Use transformed data
                rowNumbering: response.config.rowNumbering || false,
                positionChange: response.config.positionChange || false
            };

            console.log("Transformed data:", transformedData);

            // Create the table
            const tableHtml = createTable(tableConfig);
            document.getElementById('teamTableWeekDetails').innerHTML = tableHtml;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('teamTableWeekDetails').innerHTML = 
                `<div class="alert alert-danger">Error loading team details: ${error.message}</div>`;
        });
}

function updateTablePosition(data) {
    const table = document.getElementById('positionHistoryTable');
    
    // Update headers
    const headerRow = table.querySelector('thead tr');
    headerRow.innerHTML = '<th>Team</th>';
    data.weeks.forEach(week => {
        headerRow.innerHTML += `
            <th colspan="2">Week ${week}</th>
        `;
    });
    
    // Add subheader row for Points/Average
    const subheaderRow = document.createElement('tr');
    subheaderRow.innerHTML = '<th></th>';  // Empty cell for team name
    data.weeks.forEach(() => {
        subheaderRow.innerHTML += `
            <th>Points</th>
            <th>Average</th>
        `;
    });
    table.querySelector('thead').appendChild(subheaderRow);
    
    // Update body
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    data.data.forEach(teamData => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${teamData.team}</td>`;
        
        teamData.weeks.forEach(week => {
            row.innerHTML += `
                <td>${week.points.toFixed(1)}</td>
                <td>${week.average.toFixed(2)}</td>
            `;
        });
        
        tbody.appendChild(row);
    });
}

function updateSectionLeagueStandings() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) {
        console.log("Missing required selection");
        return;
    }

    fetch(`/league/get_league_history?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            // Create table configuration
            const tableConfig = {
                id: 'leagueTableHistory',
                headerGroups: data.headerGroups,
                columns: data.columns,
                data: data.data,
                sortable: true
            };

            // Call the createTable function from components/tables.html
            const tableHtml = createTable(tableConfig);
            document.getElementById('leagueTableHistory').innerHTML = tableHtml;
            
            // Update chart
            //updatePointsChart(data);
            //updateCumulativePointsChart(data);
        })
        .catch(error => console.error('Error:', error));
}

function updateTableLeagueWeek() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="week"]:checked')?.value;
    

    
    console.log('Attempting to update TableLeagueWeek with:', {
        season: selectedSeason,
        league: selectedLeague,
        week: currentWeek
    });
    
    if (!selectedSeason || !selectedLeague || !currentWeek) {
        console.log("Missing required selection");
        return;
    }
    
    const url = `/league/get_league_week?season=${selectedSeason}&league=${selectedLeague}&week=${currentWeek}&depth=${1}`;
    console.log('Fetching from URL:', url);
    
    fetch(url)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            const tableConfig = {
                id: 'tableLeagueWeek',
                headerGroups: data.headerGroups,
                columns: data.columns,
                data: data.data,
                sortable: true
            };

            const tableHtml = createTable(tableConfig);
            document.getElementById('tableLeagueWeek').innerHTML = tableHtml;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('tableLeagueWeek').innerHTML = 
                `<div class="alert alert-danger">Error loading standings: ${error.message}</div>`;
        });
}


function updateButtonsTeams() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentTeam = document.querySelector('input[name="team"]:checked')?.value;
    
    if (selectedSeason && selectedLeague) {
        fetch(`/league/get_available_teams?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(teams => {
                const buttonsTeam = document.getElementById('buttonsTeam');
                
                // Create team buttons
                const buttonsHtml = teams.map(team => `
                    <input type="radio" class="btn-check" name="team" id="team_${team}" value="${team}">
                    <label class="btn btn-outline-primary" for="team_${team}">${team}</label>
                `).join('');
                
                buttonsTeam.innerHTML = buttonsHtml;
                
                // Select team: keep current if available, otherwise take first
                if (currentTeam && teams.includes(currentTeam)) {
                    document.getElementById(`team_${currentTeam}`).checked = true;
                } else if (teams.length > 0) {
                    document.getElementById(`team_${teams[0]}`).checked = true;
                }
                
                // Update relevant tables/charts
                //updateTableLeagueWeek();
                //updateSectionLeagueStandings();
                //updateTableTeamDetails();

                // Add listeners to new team buttons
                document.querySelectorAll('input[name="team"]')
                    .forEach(input => input.addEventListener('change', updateTableTeamDetails));
            });
    }
}


function createTable(config) {
    const {
        data,
        columns,
        headerGroups = [],  // This contains the actual colspan values
        rowNumbering = true,
        positionChange = false
    } = config;

    let currentData = [...data];

    // Get colors for groups using #2196F3 as end color
    const getGroupColors = () => {
        const endColor = '#7ec2f8';  // Bootstrap primary blue
        const startRGB = [255, 255, 255];  // white
        const endRGB = hexToRgb(endColor);
        
        return headerGroups.map((_, index) => {
            if (index === 0) return 'rgb(255, 255, 255)';  // First group is white
            if (index === headerGroups.length - 1) return endColor;  // Last group is primary blue
            
            const factor = index / (headerGroups.length - 1);
            const r = Math.round(startRGB[0] + (endRGB[0] - startRGB[0]) * factor);
            const g = Math.round(startRGB[1] + (endRGB[1] - startRGB[1]) * factor);
            const b = Math.round(startRGB[2] + (endRGB[2] - startRGB[2]) * factor);
            
            return `rgb(${r}, ${g}, ${b})`;
        });
    };

    const hexToRgb = (hex) => {
        hex = hex.replace(/^#/, '');
        const bigint = parseInt(hex, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r, g, b];
    };

    const colors = getGroupColors();

    // Create mappings for column colors and last group columns
    const columnColors = {};
    const lastGroupColumns = {};
    let currentColumn = 0;
    headerGroups.forEach((group, groupIndex) => {
        const isLastGroup = groupIndex === headerGroups.length - 1;
        const colspan = group.colspan || 1;  // Get actual colspan from the group
        for (let i = 0; i < colspan; i++) {
            columnColors[currentColumn] = colors[groupIndex];
            lastGroupColumns[currentColumn] = isLastGroup;
            currentColumn++;
        }
    });

    const createHeaderGroups = () => {
        if (!headerGroups || headerGroups.length === 0) return '';
        
        return `
            <tr>
                ${headerGroups.map((group, index) => `
                    <th class="text-center" 
                        colspan="${group.colspan || 1}" 
                        style="background-color: ${colors[index]}; 
                               color: ${index === headerGroups.length - 1 ? 'white' : 'black'};">
                        ${group.title || ''}
                    </th>
                `).join('')}
            </tr>
        `;
    };

    const createColumnHeaders = () => {
        return `
            <tr>
                ${columns.map((col, index) => `
                    <th class="text-center" 
                        style="background-color: ${columnColors[index]};
                               color: ${lastGroupColumns[index] ? 'white' : 'black'};
                               font-weight: ${lastGroupColumns[index] ? 'bold' : 'normal'};">
                        ${col.title || ''}
                    </th>
                `).join('')}
            </tr>
        `;
    };

    const createTableRows = () => {
        return currentData.map((row, rowIndex) => `
            <tr>
                ${columns.map((col, colIndex) => `
                    <td class="text-center" 
                        style="background-color: ${columnColors[colIndex]};
                               color: ${lastGroupColumns[colIndex] ? 'white' : 'black'};
                               font-weight: ${lastGroupColumns[colIndex] ? 'bold' : 'normal'};
                               border-right: ${(colIndex < columns.length - 1 && 
                                              columnColors[colIndex] !== columnColors[colIndex + 1]) 
                                             ? '2px solid #dee2e6' 
                                             : '1px solid #dee2e6'};">
                        ${row[colIndex] !== undefined ? row[colIndex] : ''}
                    </td>
                `).join('')}
            </tr>
        `).join('');
    };

    return `
        <table class="table">
            <thead>
                ${createHeaderGroups()}
                ${createColumnHeaders()}
            </thead>
            <tbody>
                ${createTableRows()}
            </tbody>
        </table>
    `;
}

// Initialize the page
function initializePage() {
    console.log("Initializing page...");
    // Load available seasons
    fetch('/league/get_available_seasons')
        .then(response => response.json())
        .then(seasons => {
            const buttonsSeason = seasons.map(season => `
                <input type="radio" class="btn-check" name="season" id="season_${season}" value="${season}">
                <label class="btn btn-outline-primary" for="season_${season}">${season}</label>
            `).join('');
            document.getElementById('buttonsSeason').innerHTML = buttonsSeason;
        });

    // Load available leagues
    fetch('/league/get_available_leagues')
        .then(response => response.json())
        .then(leagues => {
            const buttonsLeague = leagues.map(league => `
                <input type="radio" class="btn-check" name="league" id="league_${league}" value="${league}">
                <label class="btn btn-outline-primary" for="league_${league}">${league}</label>
            `).join('');
            document.getElementById('buttonsLeague').innerHTML = buttonsLeague;
        });
}

// Handle selection changes
function handleSelectionChange() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    const messageArea = document.getElementById('selectionMessage');
    const tableArea = document.getElementById('leagueTableHistory');
    
    if (selectedSeason && selectedLeague) {
        messageArea.style.display = 'none';
        tableArea.style.display = 'block';
        updateSectionLeagueStandings();
        updateChartsLeague();
        
    } else {
        messageArea.style.display = 'block';
        tableArea.style.display = 'none';
    }
}

// Update available weeks and teams when season/league selection changes
function updateAvailableOptions() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;

    console.log("Updating available options for:", {
        season: selectedSeason,
        league: selectedLeague
    });

    if (selectedSeason && selectedLeague) {
        // Update available weeks
        fetch(`/league/get_available_weeks?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(weeks => {
                const weekButtons = weeks.map(week => `
                    <input type="radio" class="btn-check" name="week" id="week_${week}" value="${week}">
                    <label class="btn btn-outline-primary" for="week_${week}">${week}</label>
                `).join('');
                document.getElementById('buttonsWeek').innerHTML = weekButtons;
            });

        // Update available teams
        fetch(`/league/get_available_teams?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(teams => {
                const teamButtons = teams.map(team => `
                    <input type="radio" class="btn-check" name="team" id="team_${team}" value="${team}">
                    <label class="btn btn-outline-primary" for="team_${team}">${team}</label>
                `).join('');
                document.getElementById('buttonsTeam').innerHTML = teamButtons;
            });
    } else {
        // Clear buttons if no season/league selected
        document.getElementById('buttonsWeek').innerHTML = '';
        document.getElementById('buttonsTeam').innerHTML = '';
    }
}

// Handle week/team selection changes
function handleWeekTeamSelection() {
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    const selectedTeam = document.querySelector('input[name="team"]:checked')?.value;
    
    const messageArea = document.getElementById('weekMessage');
    const standingsTable = document.getElementById('tableLeagueWeek');
    
    if (selectedWeek) {
        messageArea.style.display = 'none';
        standingsTable.style.display = 'block';
        
        updateTableLeagueWeek();

        
        if (selectedTeam) {
            updateTableTeamDetails();
        }
    } else {
        messageArea.style.display = 'block';
        standingsTable.style.display = 'none';
    }
}

// Handle week selection changes
function handleWeekSelection() {
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    console.log("Week selection changed:", {
        week: selectedWeek,
        season: selectedSeason,
        league: selectedLeague
    });
    
    if (selectedWeek && selectedSeason && selectedLeague) {
        // Check if elements exist before updating
        const weekMessage = document.getElementById('weekMessage');
        const tableLeagueWeek = document.getElementById('tableLeagueWeek');
        
        if (weekMessage) {
            weekMessage.style.display = 'none';
        } else {
            console.error('weekMessage element not found');
        }
        
        if (tableLeagueWeek) {
            tableLeagueWeek.style.display = 'block';
        } else {
            console.error('tableLeagueWeek element not found');
        }
        
        // Update league standings
        //handleLeagueStandings();
        
        // Update honor scores
        updateHonorScores();
    }
}

function updateHonorScores() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague || !selectedWeek) {
        return;
    }
    
    fetch(`/league/get_honor_scores?season=${selectedSeason}&league=${selectedLeague}&week=${selectedWeek}`)
        .then(response => response.json())
        .then(data => {
            // Individual Scores
            document.getElementById('individualScores').innerHTML = data.individual_scores
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.Player}</span>
                    <span class="fw-bold">${item.Score}</span>
                </div>`).join('');
            
            // Team Scores
            document.getElementById('teamScores').innerHTML = data.team_scores
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.Team}</span>
                    <span class="fw-bold">${item.Score}</span>
                </div>`).join('');
            
            // Individual Averages
            document.getElementById('individualAverages').innerHTML = data.individual_averages
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.Player}</span>
                    <span class="fw-bold">${item.Score.toFixed(1)}</span>
                </div>`).join('');
            
            // Team Averages
            document.getElementById('teamAverages').innerHTML = data.team_averages
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.Team}</span>
                    <span class="fw-bold">${item.Score.toFixed(1)}</span>
                </div>`).join('');
        })
        .catch(error => console.error('Error:', error));
}

function updateTeamAveragesChart() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) return;

    fetch(`/league/get_team_averages?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('teamAveragesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.teamAveragesChart instanceof Chart) {
                window.teamAveragesChart.destroy();
            }
            
            window.teamAveragesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => `Week ${d.week}`),
                    datasets: [{
                        label: 'Average Points',
                        data: data.map(d => d.average),
                        borderColor: '#6FAED4',
                        backgroundColor: '#6FAED4',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Average Points for ${selectedTeam}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
}


function updateChartsLeague() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) return;

    console.log("Updating charts for:", {
        season: selectedSeason,
        league: selectedLeague
    });
    
    fetch(`/league/get_available_teams?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(teams => {
                updateSharedLegend(teams);
            });
    
    // Fetch and create position charts
    fetch(`/league/get_team_positions?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            // Create labels based on number of weeks
            const numWeeks = Object.values(data.weekly)[0].length;
            const labels = Array.from({length: numWeeks}, (_, i) => `Spieltag ${i + 1}`);

            // Create weekly positions chart
            createLineChart(
                data.weekly,
                'chartTeamPositionWeekly',
                'Platzierung pro Spieltag',
                labels, 
                true   
            );

            // Create cumulative positions chart
            createLineChart(
                data.cumulative,
                'chartTeamPositionCumulated',
                'Platzierung im Saisonverlauf',
                labels,
                true
            );
        });

        // Fetch and create points charts
        fetch(`/league/get_team_points?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            // Create labels based on number of weeks
            const numWeeks = Object.values(data.weekly)[0].length;
            const labels = Array.from({length: numWeeks}, (_, i) => `Spieltag ${i + 1}`);

            // Create weekly positions chart
            createLineChart(
                data.weekly,
                'chartTeamPointsWeekly',
                'Punkte pro Spieltag',
                labels,
                false
            );

            // Create cumulative positions chart
            createLineChart(
                data.cumulative,
                'chartTeamPointsCumulated',
                'Punkte im Saisonverlauf',
                labels,
                false
            );
        });
}


// Add to your existing event listeners
document.querySelectorAll('input[name="team"], input[name="season"], input[name="league"]')
    .forEach(input => {
        input.addEventListener('change', () => {

            updateChartsLeague();
        });
    });

// Initial load
document.addEventListener('DOMContentLoaded', () => {
    initializePage();
    
    // Listen for button changes
    document.addEventListener('change', event => {
        if (event.target.name === 'season' || event.target.name === 'league') {
            handleSelectionChange();
            updateAvailableOptions();
            console.log('Updating available options after season/league change');
        }
        // Listen for week/team selection changes
        if (event.target.name === 'week' || event.target.name === 'team') {
            updateTableTeamDetails();
            updateTableLeagueWeek();
            
            handleWeekTeamSelection();
            handleWeekSelection();
        }
    });


    updateChartsLeague();
});
</script>
{% endblock %}