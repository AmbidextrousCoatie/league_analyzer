{% extends "base.html" %}

{% block content %}
    {% include "components/tables.html" %}
    {% include "components/charts.html" %}

<div class="container-fluid">
    <!-- Debug Test Button -->
    <div class="row mb-3">
        <div class="col-12">
            <button id="debugTestBtn" class="btn btn-warning btn-sm">
                🐛 Test Frontend Database Parameter
            </button>
            <span id="debugResult" class="ms-2"></span>
        </div>
    </div>

    <!-- Filter Controls Block -->
    <div id="filterControlsContainer">
        <!-- Filter controls will be rendered here -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading filters...</span>
            </div>
            <p class="text-muted mt-2">Initializing filter controls...</p>
        </div>
    </div>

    <!-- League Aggregation Block (League only) -->
    <div id="leagueAggregationContainer">
        <!-- League aggregation content will be rendered here -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading league aggregation...</span>
            </div>
            <p class="text-muted mt-2">Initializing league aggregation...</p>
        </div>
    </div>

    <!-- League Season Overview Block (League + Season) -->
    <div id="leagueSeasonOverviewContainer">
        <!-- League season overview content will be rendered here -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading season overview...</span>
            </div>
            <p class="text-muted mt-2">Initializing season overview...</p>
        </div>
    </div>

    <!-- Season Overview Block (League + Season + Week/Team) -->
    <div id="seasonOverviewContainer">
        <!-- Season overview content will be rendered here -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading detailed overview...</span>
            </div>
            <p class="text-muted mt-2">Initializing detailed overview...</p>
        </div>
    </div>

    <!-- Match Day Block -->
    <div id="matchdayContainer">
        <!-- Match day content will be rendered here -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading match day content...</span>
            </div>
            <p class="text-muted mt-2">Initializing match day content...</p>
        </div>
    </div>

    <!-- Team Details Block -->
    <div id="teamDetailsContainer">
        <!-- Team details content will be rendered here -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading team details...</span>
            </div>
            <p class="text-muted mt-2">Initializing team details...</p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Core dependencies -->
<script src="{{ url_for('static', filename='js/core/url-state-manager.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-blocks/base-content-block.js') }}"></script>

<!-- Content blocks -->
<script src="{{ url_for('static', filename='js/content-blocks/filter-controls-block.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-blocks/league-aggregation-block.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-blocks/league-season-overview-block.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-blocks/season-overview-block.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-blocks/matchday-block.js') }}"></script>
<script src="{{ url_for('static', filename='js/content-blocks/team-details-block.js') }}"></script>

<!-- Main application -->
<script src="{{ url_for('static', filename='js/league-stats-app.js') }}"></script>

<!-- Initialize i18n translations if available -->
{% if translations %}
<script>
    window.translations = {{ translations|tojson }};
</script>
{% endif %}

<!-- Debug test script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const debugBtn = document.getElementById('debugTestBtn');
    const debugResult = document.getElementById('debugResult');
    
    if (debugBtn) {
        debugBtn.addEventListener('click', async function() {
            debugResult.textContent = '🔄 Testing...';
            
            try {
                console.log('🔄 Debug test button clicked');
                console.log('🔄 Current URL:', window.location.href);
                console.log('🔄 Database parameter:', getCurrentDatabase());
                
                // Test if classes are available
                console.log('🔄 BaseContentBlock available:', typeof BaseContentBlock);
                console.log('🔄 FilterControlsBlock available:', typeof FilterControlsBlock);
                
                // Test the fetchWithDatabase function
                const response = await fetchWithDatabase('/league/get_available_seasons');
                const data = await response.json();
                
                console.log('✅ Debug test successful:', data);
                debugResult.textContent = `✅ Success: ${JSON.stringify(data)}`;
                
            } catch (error) {
                console.error('❌ Debug test failed:', error);
                debugResult.textContent = `❌ Error: ${error.message}`;
            }
        });
    }
});
</script>

<!-- Legacy compatibility for external integrations -->
<script>
// Backward compatibility functions for external tools that might call these
window.updateAllContent = function() {
    if (window.leagueStatsApp) {
        window.leagueStatsApp.renderContent();
    }
};

window.handleSelectionChange = function() {
    if (window.leagueStatsApp) {
        window.leagueStatsApp.renderContent();
    }
};

// Make chart refresh function available globally
window.refreshAllCharts = function() {
    if (window.leagueStatsApp) {
        window.leagueStatsApp.renderContent();
    }
};
</script>
{% endblock %}