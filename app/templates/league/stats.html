{% extends "base.html" %}

{% block content %}
    {% include "components/tables.html" %}
    {% include "components/charts.html" %}

<div class="container-fluid">
    <!-- Selection Area -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 data-i18n="league_statistics">League Statistics</h4>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <h5 data-i18n="season">Season</h5>
                    <div id="buttonsSeason" class="btn-group-horizontal w-100">
                        <!-- Seasons will be inserted here -->
                    </div>
                </div>
                <div class="col-md-4">
                    <h5 data-i18n="league">League</h5>
                    <div id="buttonsLeague" class="btn-group-horizontal w-100">
                        <!-- Leagues will be inserted here -->
                    </div>
                </div>
                <div class="col-md-4">
                    <h5 data-i18n="week">Week</h5>
                    <div id="buttonsWeek" class="btn-group-horizontal w-100">
                        <!-- Weeks will be inserted here -->
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <h5 data-i18n="team">Team</h5>
                    <div id="buttonsTeam" class="btn-group-horizontal w-100">
                        <!-- Teams will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- League History Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 data-i18n="season_overview">Season Overview</h5>
        </div>
        <!-- Message Area -->
        <div id="selectionMessage" class="alert alert-danger" style="font-size: 1.5rem; font-weight: bold;" data-i18n="please_select_combination">
            Please select a combination of Season and League.
        </div>

        <!-- Table Area -->
        <div id="leagueTableHistory" style="display: none">
            <!-- Table will be inserted here -->
        </div>

        <div class="card-body">
            <!-- Position Charts -->
            <div class="row">
                <!-- Positions over the course of the season -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 data-i18n="position_in_season_progress">Position in Season Progress</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamPositionCumulated" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>            
                <!-- Points over the course of the season -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 data-i18n="points_in_season_progress">Points in Season Progress</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamPointsCumulated" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Shared Legend -->
            <div class="row mt-3">
                <div class="col-12">
                    <div id="sharedLegend" class="d-flex justify-content-center flex-wrap">
                        <!-- Legend will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            <!-- Points Charts -->
            <div class="row">
                <!-- Points per Week Chart -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 data-i18n="points_per_match_day">Points per Match Day</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamPointsWeekly" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <!-- Average per Week Chart -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 data-i18n="average_per_match_day">Average per Match Day</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamAverageScoreWeekly" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Shared Legend -->
            <div class="row mt-3">
                <div class="col-12">
                    <div id="sharedLegendMiddle" class="d-flex justify-content-center flex-wrap">
                        <!-- Legend will be dynamically inserted here -->
                    </div>
                </div>
            </div>
            <!-- misc Charts -->
            <!--div class="row">
                <!-!- Position per Week Chart -|->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 data-i18n="position_per_match_day">Position per Match Day</h5>
                        </div>
                        <div class="card-body">
                            <div id="chartTeamPositionWeekly" style="width: 100%; min-width: 100%; height: 300px;"></div>
                        </div>
                    </div>
                </div>
                <!-!- Points vs Average -|->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 data-i18n="points_vs_average">Points vs. Average</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="chartTeamPointsVsAverage"></canvas>
                        </div>
                    </div>
                </div>
            </div>-->
        </div>
    </div>  

    <!-- League Results - Match Day -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 data-i18n="league_results_match_day">League Results - Match Day</h5>
        </div>
        <div class="card-body">
            <!-- Message Area -->
            <div id="weekMessage" class="alert alert-info" data-i18n="please_select_match_day">
                Please select a match day.
            </div>
        
            <!-- Content Area -->
            <div class="row">
                <div class="col-md-8">
                    <div id="tableLeagueWeek" style="display: none">
                        <!-- Table will be dynamically inserted here -->
                    </div>
                </div>
                <div class="col-md-4">
                    <div id="honorScores" class="card">
                        <div class="card-header">
                            <h5 data-i18n="honor_scores">Honor Scores</h5>
                        </div>
                        <div class="card-body">
                            <!-- Make sure these IDs exist -->
                            <div class="mb-3">
                                <h6 data-i18n="top_individual_scores">Top Individual Scores</h6>
                                <div id="individualScores"></div>
                            </div>
                            <div class="mb-3">
                                <h6 data-i18n="top_team_scores">Top Team Scores</h6>
                                <div id="teamScores"></div>
                            </div>
                            <div class="mb-3">
                                <h6 data-i18n="best_individual_averages">Best Individual Averages</h6>
                                <div id="individualAverages"></div>
                            </div>
                            <div class="mb-3">
                                <h6 data-i18n="best_team_averages">Best Team Averages</h6>
                                <div id="teamAverages"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Details Section -->
        <div class="card-body">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 data-i18n="score_sheet_selected_team">Score Sheet for Selected Team</h5>
                        <div id="teamDetailsMetadata" class="text-muted small"></div>
                    </div>
                    <div class="btn-group" role="group" aria-label="View options">
                        <input type="radio" class="btn-check" name="teamView" id="teamViewClassic" value="classic" checked>
                        <label class="btn btn-outline-primary btn-sm" for="teamViewClassic">Classic</label>
                        <input type="radio" class="btn-check" name="teamView" id="teamViewNew" value="new">
                        <label class="btn btn-outline-primary btn-sm" for="teamViewNew">New</label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="teamTableWeekDetails">
                        <!-- Team table will be dynamically inserted here -->
                        <div class="alert alert-info" data-i18n="please_select_team">Please select a team to display the score sheet.</div>
                    </div>
                </div>
            </div>  
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script>

let positionChart = null;

function updateSharedLegend(teams) {
    const legendHtml = teams.map(team => `
        <div class="mx-3 mb-2 d-flex align-items-center">
            <div style="width: 20px; height: 20px; border-radius: 50%; background-color: ${getTeamColor(team)}; margin-right: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                
            </div>
            <span>${team}</span>
        </div>
    `).join('');
    
    document.getElementById('sharedLegend').innerHTML = legendHtml;
    document.getElementById('sharedLegendMiddle').innerHTML = legendHtml;
}

function updatePositionChart() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="week"]:checked')?.value;
    
    if (selectedSeason && selectedLeague) {
        fetch(`/league/get_position_history?season=${selectedSeason}&league=${selectedLeague}&week=${currentWeek}&depth=${currentWeek}`)
            .then(response => response.json())
            .then(data => {
                // Destroy existing chart if it exists
                if (positionChart) positionChart.destroy();
                
                // Updated color palette
                const colors = [
                    '#28255c', '#592a6b', '#882c70', '#b4306b',
                    '#d8405e', '#f25b4a', '#ff7f30', '#ffa600'
                ];
                
                // Assign colors to teams
                const teamColors = data.teams.reduce((acc, team, index) => {
                    acc[team] = colors[index % colors.length];
                    return acc;
                }, {});
                
                // Create new chart
                positionChart = new Chart(document.getElementById('positionChart'), {
                    type: 'line',
                    data: {
                        labels: data.weeks,
                        datasets: data.teams.map(team => ({
                            label: team,
                            data: data.data
                                .filter(d => d.team === team)
                                .sort((a, b) => a.week - b.week)
                                .map(d => d.position),
                            borderColor: teamColors[team],
                            backgroundColor: teamColors[team],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            pointStyle: 'circle',
                        }))
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                reverse: true,
                                min: 0.5,
                                max: data.teams.length + 0.5,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : '';
                                    }
                                },
                                grid: {
                                    color: '#f0f0f0',
                                    offset: false,
                                    drawTicks: true,
                                    drawOnChartArea: true,
                                    // Align grid with integer positions
                                    z: 1,
                                    tickOffset: 0,
                                    tickLength: 0
                                },
                                afterFit: function(scaleInstance) {
                                    // Ensure grid lines align with positions
                                    scaleInstance.options.grid.offset = false;
                                },
                                afterDataLimits: (scale) => {
                                    // Align grid with integer positions
                                    scale.min = 0.5;
                                    scale.max = data.teams.length + 0.5;
                                },
                                title: { 
                                    display: true, 
                                    text: 'Position',
                                    font: { weight: 'bold' },
                                    padding: { top: 10, bottom: 10 }
                                }
                            },
                            x: {
                                grid: {
                                    drawTicks: true
                                },
                                title: {
                                    display: true,
                                    text: window.translations ? (window.translations['match_day_label'] || 'Match Day') : 'Match Day',
                                    font: { weight: 'bold' },
                                    padding: { top: 10, bottom: 10 }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const team = context.dataset.label;
                                        const position = context.parsed.y;
                                        const points = data.data.find(d => 
                                            d.team === team && d.week === context.parsed.x
                                        ).points;
                                        return `${team}: Position ${position} (${points} pts)`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 10
                                }
                            }
                        },
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error:', error));
    }
}

function updateTableTeamDetails() {
    const selectedSeason = currentState?.season || document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = currentState?.league || document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = currentState?.week || document.querySelector('input[name="week"]:checked')?.value;
    const selectedTeam = currentState?.team || document.querySelector('input[name="team"]:checked')?.value;
    const selectedView = currentState?.teamView || document.querySelector('input[name="teamView"]:checked')?.value;
    let endpoint = '/league/get_team_week_details_table';
    let viewMode = undefined;
    if (selectedView === 'new') {
        endpoint = '/league/get_team_individual_scores_table';
    } else if (selectedView === 'newFull') {
        endpoint = '/league/get_team_week_head_to_head_table';
        viewMode = 'full';
    }
    if (!selectedSeason || !selectedLeague || !selectedWeek || !selectedTeam) {
        return;
    }
    // Update header
    const matchDayText = window.translations ? (window.translations['match_day_label'] || 'Match Day') : 'Match Day';
    document.getElementById('teamDetailsMetadata').innerHTML = `${selectedTeam} - ${matchDayText} ${selectedWeek}`;
    // Use fetchAndRenderTable for consistent table rendering
    const params = {
        season: selectedSeason,
        league: selectedLeague,
        week: selectedWeek,
        team: selectedTeam,
        options: {
            disablePositionCircle: true,
            mergeCells: false,
            enableSpecialRowStyling: true
        }
    };
    if (viewMode) {
        params.view_mode = viewMode;
    }
    fetchAndRenderTable('teamTableWeekDetails', endpoint, params);
}

function updateTablePosition(data) {
    const table = document.getElementById('positionHistoryTable');
    
    // Update headers
    const headerRow = table.querySelector('thead tr');
    headerRow.innerHTML = '<th>Team</th>';
    data.weeks.forEach(week => {
        headerRow.innerHTML += `
            <th colspan="2">Week ${week}</th>
        `;
    });
    
    // Add subheader row for Points/Average
    const subheaderRow = document.createElement('tr');
    subheaderRow.innerHTML = '<th></th>';  // Empty cell for team name
    data.weeks.forEach(() => {
        subheaderRow.innerHTML += `
            <th>Points</th>
            <th>Average</th>
        `;
    });
    table.querySelector('thead').appendChild(subheaderRow);
    
    // Update body
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    data.data.forEach(teamData => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${teamData.team}</td>`;
        
        teamData.weeks.forEach(week => {
            row.innerHTML += `
                <td>${week.points.toFixed(1)}</td>
                <td>${week.average.toFixed(2)}</td>
            `;
        });
        
        tbody.appendChild(row);
    });
}



function updateTableLeagueWeek() {
    const selectedSeason = currentState?.season || document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = currentState?.league || document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = currentState?.week || document.querySelector('input[name="week"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) {
        return;
    }
    
    if (!selectedWeek) {
        // Show message when no week is selected
        const messageArea = document.getElementById('weekMessage');
        const standingsTable = document.getElementById('tableLeagueWeek');
        
        if (messageArea) {
            messageArea.style.display = 'block';
            messageArea.innerHTML = window.translations ? (window.translations['please_select_match_day'] || 'Please select a match day.') : 'Please select a match day.';
        }
        if (standingsTable) standingsTable.style.display = 'none';
        return;
    }
    
    // Show the table and hide the message
    const messageArea = document.getElementById('weekMessage');
    const standingsTable = document.getElementById('tableLeagueWeek');
    
    if (messageArea) messageArea.style.display = 'none';
    if (standingsTable) standingsTable.style.display = 'block';
    
    // Fetch and display table
    fetchAndRenderTable('tableLeagueWeek', '/league/get_league_week_table', {
        season: selectedSeason,
        league: selectedLeague,
        week: selectedWeek
    });
}

function updateTableLeagueHistory() {
    const selectedSeason = currentState?.season || document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = currentState?.league || document.querySelector('input[name="league"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) {
        document.getElementById('selectionMessage').style.display = 'block';
        document.getElementById('leagueTableHistory').style.display = 'none';
        return;
    }
    
    document.getElementById('selectionMessage').style.display = 'none';
    document.getElementById('leagueTableHistory').style.display = 'block';
    
    // Fetch and display table
    fetchAndRenderTable('leagueTableHistory', '/league/get_league_history', {
        season: selectedSeason,
        league: selectedLeague
    });
}

// Global state management
let currentState = {
    season: null,
    league: null,
    week: null,
    team: null,
    teamView: 'classic'
};

// Initialize the page
function initializePage() {
    console.log("Initializing page...");
    
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const selectedSeason = urlParams.get('season');
    const selectedLeague = urlParams.get('league');
    const selectedWeek = urlParams.get('week');
    const selectedTeam = urlParams.get('team');
    
    console.log("URL parameters:", { season: selectedSeason, league: selectedLeague, week: selectedWeek, team: selectedTeam });

    // --- Centralized State Management ---
    currentState = {
        season: selectedSeason,
        league: selectedLeague,
        week: selectedWeek,
        team: selectedTeam,
        teamView: 'classic'
    };

    // --- URL Parameter Validation System ---
    async function validateAndFixUrlParameters() {
        console.log("Validating URL parameters against current data source...");
        
        let needsUrlUpdate = false;
        const newUrlParams = new URLSearchParams(window.location.search);
        
        // Validate season
        try {
            const availableSeasons = await fetch('/league/get_available_seasons').then(r => r.json());
            if (currentState.season && !availableSeasons.includes(currentState.season)) {
                console.log(`Invalid season: ${currentState.season}. Available: ${availableSeasons}`);
                currentState.season = availableSeasons[0] || null;
                if (currentState.season) {
                    newUrlParams.set('season', currentState.season);
                    needsUrlUpdate = true;
                } else {
                    newUrlParams.delete('season');
                }
            }
        } catch (error) {
            console.error('Error validating season:', error);
        }
        
        // Validate league
        if (currentState.season) {
            try {
                const availableLeagues = await fetch(`/league/get_available_leagues?season=${currentState.season}`).then(r => r.json());
                if (currentState.league && !availableLeagues.includes(currentState.league)) {
                    console.log(`Invalid league: ${currentState.league}. Available: ${availableLeagues}`);
                    currentState.league = availableLeagues[0] || null;
                    if (currentState.league) {
                        newUrlParams.set('league', currentState.league);
                        needsUrlUpdate = true;
                    } else {
                        newUrlParams.delete('league');
                    }
                }
            } catch (error) {
                console.error('Error validating league:', error);
            }
        }
        
        // Validate week
        if (currentState.season && currentState.league) {
            try {
                const availableWeeks = await fetch(`/league/get_available_weeks?season=${currentState.season}&league=${currentState.league}`).then(r => r.json());
                if (currentState.week && !availableWeeks.includes(parseInt(currentState.week))) {
                    console.log(`Invalid week: ${currentState.week}. Available: ${availableWeeks}`);
                    const latestWeek = Math.max(...availableWeeks);
                    currentState.week = latestWeek.toString();
                    newUrlParams.set('week', currentState.week);
                    needsUrlUpdate = true;
                }
            } catch (error) {
                console.error('Error validating week:', error);
            }
        }
        
        // Validate team
        if (currentState.season && currentState.league) {
            try {
                const availableTeams = await fetch(`/league/get_available_teams?season=${currentState.season}&league=${currentState.league}`).then(r => r.json());
                if (currentState.team && !availableTeams.includes(currentState.team)) {
                    console.log(`Invalid team: ${currentState.team}. Available: ${availableTeams}`);
                    currentState.team = availableTeams[0] || null;
                    if (currentState.team) {
                        newUrlParams.set('team', currentState.team);
                        needsUrlUpdate = true;
                    } else {
                        newUrlParams.delete('team');
                    }
                }
            } catch (error) {
                console.error('Error validating team:', error);
            }
        }
        
        // Update URL if needed
        if (needsUrlUpdate) {
            const newUrl = `${window.location.pathname}?${newUrlParams.toString()}`;
            console.log(`Updating URL from ${window.location.href} to ${newUrl}`);
            window.history.replaceState({}, '', newUrl);
            
            // Show user notification
            showUrlUpdateNotification();
        }
        
        return currentState;
    }
    
    async function resetToDefaultParameters() {
        console.log("Resetting to default parameters due to data source change...");
        
        try {
            // Get available data
            const availableSeasons = await fetch('/league/get_available_seasons').then(r => r.json());
            const defaultSeason = availableSeasons[0];
            
            if (defaultSeason) {
                const availableLeagues = await fetch(`/league/get_available_leagues?season=${defaultSeason}`).then(r => r.json());
                const defaultLeague = availableLeagues[0];
                
                if (defaultLeague) {
                    const availableWeeks = await fetch(`/league/get_available_weeks?season=${defaultSeason}&league=${defaultLeague}`).then(r => r.json());
                    const defaultWeek = Math.max(...availableWeeks);
                    
                    // Update state and URL
                    currentState = {
                        season: defaultSeason,
                        league: defaultLeague,
                        week: defaultWeek.toString(),
                        team: null,
                        teamView: 'classic'
                    };
                    
                    const newUrl = `${window.location.pathname}?season=${defaultSeason}&league=${defaultLeague}&week=${defaultWeek}`;
                    window.history.replaceState({}, '', newUrl);
                    
                    showUrlUpdateNotification();
                    return true;
                }
            }
        } catch (error) {
            console.error('Error resetting to default parameters:', error);
        }
        
        return false;
    }
    
    function showUrlUpdateNotification() {
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show';
        notification.innerHTML = `
            <strong>Data Source Changed:</strong> Some URL parameters were automatically adjusted to match the current data source.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the main content
        const mainContent = document.querySelector('.container-fluid') || document.body;
        mainContent.insertBefore(notification, mainContent.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // --- Robust Event System ---
    const EventTypes = {
        DATA_SOURCE_CHANGED: 'dataSourceChanged',
        PALETTE_CHANGED: 'paletteChanged',
        BUTTON_PRESSED: 'buttonPressed',
        PAGE_LOADED: 'pageLoaded'
    };

    // Event handlers for different scenarios
    const eventHandlers = {
        [EventTypes.DATA_SOURCE_CHANGED]: async () => {
            console.log('Data source changed - validating parameters and updating UI');
            try {
                await validateAndFixUrlParameters();
                updateAllButtons();
                updateAllContent();
            } catch (error) {
                console.error('Error during data source change handling:', error);
                // If validation fails completely, reset to defaults
                const resetSuccess = await resetToDefaultParameters();
                if (resetSuccess) {
                    updateAllButtons();
                    updateAllContent();
                } else {
                    // Show error message if even reset fails
                    showDataUnavailableMessage('Unable to load data after source change. Please refresh the page.', 'mainContent');
                }
            }
        },
        [EventTypes.PALETTE_CHANGED]: () => {
            console.log('Palette changed - updating content only');
            updateAllContent();
        },
        [EventTypes.BUTTON_PRESSED]: (buttonType) => {
            console.log(`Button pressed: ${buttonType} - updating buttons and content`);
            updateButtonsForButtonType(buttonType);
            updateContentForButtonType(buttonType);
        },
        [EventTypes.PAGE_LOADED]: async () => {
            console.log('Page loaded - initializing with smart defaults');
            try {
                await validateAndFixUrlParameters();
                initializeWithSmartDefaults();
            } catch (error) {
                console.error('Error during page initialization:', error);
                // If validation fails, reset to defaults
                const resetSuccess = await resetToDefaultParameters();
                if (resetSuccess) {
                    initializeWithSmartDefaults();
                } else {
                    showDataUnavailableMessage('Unable to initialize page. Please refresh.', 'mainContent');
                }
            }
        }
    };

    // Dispatch events
    function dispatchEvent(eventType, data = null) {
        const handler = eventHandlers[eventType];
        if (handler) {
            handler(data);
        }
    }
    
    // Make event system globally accessible for navbar
    window.dispatchEvent = dispatchEvent;
    window.EventTypes = EventTypes;

    // --- Button Update Functions ---
    function updateAllButtons() {
        updateSeasonButtons();
        updateLeagueButtons();
        updateWeekButtons();
        updateTeamButtons();
    }

    function updateSeasonButtons() {
        fetch('/league/get_available_seasons')
            .then(response => response.json())
            .then(seasons => {
                const buttonsSeason = seasons.map(season => `
                    <input type="radio" class="btn-check" name="season" id="season_${season}" 
                           value="${season}" ${season === currentState.season ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="season_${season}">${season}</label>
                `).join('');
                document.getElementById('buttonsSeason').innerHTML = buttonsSeason;
                
                // Auto-select if none selected
                const seasonInputs = document.querySelectorAll('input[name="season"]');
                if (![...seasonInputs].some(input => input.checked) && seasonInputs.length > 0) {
                    seasonInputs[0].checked = true;
                    currentState.season = seasonInputs[0].value;
                }
            })
            .catch(error => {
                console.error('Error loading seasons:', error);
                document.getElementById('buttonsSeason').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading seasons:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });
    }

    function updateLeagueButtons() {
        if (!currentState.season) return;
        
        fetch(`/league/get_available_leagues?season=${currentState.season}`)
            .then(response => response.json())
            .then(leagues => {
                const buttonsLeague = leagues.map(league => `
                    <input type="radio" class="btn-check" name="league" id="league_${league}" 
                           value="${league}" ${league === currentState.league ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="league_${league}">${league}</label>
                `).join('');
                document.getElementById('buttonsLeague').innerHTML = buttonsLeague;
                
                // Auto-select highest league if none selected
                const leagueInputs = document.querySelectorAll('input[name="league"]');
                if (![...leagueInputs].some(input => input.checked) && leagueInputs.length > 0) {
                    // Sort leagues and select the "highest" one (assuming alphabetical order works)
                    const sortedLeagues = leagues.sort();
                    const highestLeague = sortedLeagues[sortedLeagues.length - 1];
                    const highestInput = document.querySelector(`input[name="league"][value="${highestLeague}"]`);
                    if (highestInput) {
                        highestInput.checked = true;
                        currentState.league = highestLeague;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading leagues:', error);
                document.getElementById('buttonsLeague').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading leagues:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });
    }

    function updateWeekButtons() {
        if (!currentState.season || !currentState.league) return;
        
        fetch(`/league/get_available_weeks?season=${currentState.season}&league=${currentState.league}`)
            .then(response => response.json())
            .then(weeks => {
                const weekButtons = weeks.map(week => `
                    <input type="radio" class="btn-check" name="week" id="week_${week}" 
                           value="${week}" ${week.toString() === currentState.week ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="week_${week}">${week}</label>
                `).join('');
                document.getElementById('buttonsWeek').innerHTML = weekButtons;
                
                // Auto-select latest week if none selected
                const weekInputs = document.querySelectorAll('input[name="week"]');
                if (![...weekInputs].some(input => input.checked) && weekInputs.length > 0) {
                    const latestWeek = Math.max(...weeks);
                    const latestInput = document.querySelector(`input[name="week"][value="${latestWeek}"]`);
                    if (latestInput) {
                        latestInput.checked = true;
                        currentState.week = latestWeek.toString();
                    }
                }
            })
            .catch(error => {
                console.error('Error loading weeks:', error);
                document.getElementById('buttonsWeek').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading weeks:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });
    }

    function updateTeamButtons() {
        if (!currentState.season || !currentState.league) return;
        
        fetch(`/league/get_available_teams?season=${currentState.season}&league=${currentState.league}`)
            .then(response => response.json())
            .then(teams => {
                const teamButtons = teams.map(team => `
                    <input type="radio" class="btn-check" name="team" id="team_${team.replace(/\s+/g, '_')}" 
                           value="${team}" ${team === currentState.team ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="team_${team.replace(/\s+/g, '_')}">${team}</label>
                `).join('');
                document.getElementById('buttonsTeam').innerHTML = teamButtons;
                
                // Auto-select first team if none selected
                const teamInputs = document.querySelectorAll('input[name="team"]');
                if (![...teamInputs].some(input => input.checked) && teamInputs.length > 0) {
                    teamInputs[0].checked = true;
                    currentState.team = teamInputs[0].value;
                }
            })
            .catch(error => {
                console.error('Error loading teams:', error);
                document.getElementById('buttonsTeam').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading teams:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });
    }

    function updateButtonsForButtonType(buttonType) {
        switch (buttonType) {
            case 'season':
                updateLeagueButtons();
                updateWeekButtons();
                updateTeamButtons();
                break;
            case 'league':
                updateWeekButtons();
                updateTeamButtons();
                break;
            case 'week':
                // No dependent buttons for week
                break;
            case 'team':
                // No dependent buttons for team
                break;
        }
    }

    // --- Content Update Functions ---
    function updateAllContent() {
        updateTableLeagueHistory();
        updateTableLeagueWeek();
        updateChartsLeague();
        updateHonorScores();
        updateTableTeamDetails();
    }

    function updateContentForButtonType(buttonType) {
        switch (buttonType) {
            case 'season':
            case 'league':
                updateTableLeagueHistory();
                updateTableLeagueWeek();
                updateChartsLeague();
                updateHonorScores();
                updateTableTeamDetails();
                break;
            case 'week':
                updateTableLeagueWeek();
                updateHonorScores();
                updateTableTeamDetails();
                break;
            case 'team':
                updateTableTeamDetails();
                break;
            case 'teamView':
                updateTableTeamDetails();
                break;
        }
    }

    // --- Smart Default Initialization ---
    function initializeWithSmartDefaults() {
        // Start with seasons
        updateSeasonButtons();
        
        // After seasons load, load leagues
        setTimeout(() => {
            updateLeagueButtons();
            
            // After leagues load, load weeks
            setTimeout(() => {
                updateWeekButtons();
                
                // After weeks load, load teams
                setTimeout(() => {
                    updateTeamButtons();
                    
                    // After everything loads, update content
                    setTimeout(() => {
                        updateAllContent();
                    }, 100);
                }, 100);
            }, 100);
        }, 100);
    }

    // --- Event Listeners ---
    document.addEventListener('change', event => {
        const name = event.target.name;
        const value = event.target.value;
        
        // Update current state
        if (name === 'season') {
            currentState.season = value;
            currentState.league = null;
            currentState.week = null;
            currentState.team = null;
        } else if (name === 'league') {
            currentState.league = value;
            currentState.week = null;
            currentState.team = null;
        } else if (name === 'week') {
            currentState.week = value;
        } else if (name === 'team') {
            currentState.team = value;
        } else if (name === 'teamView') {
            currentState.teamView = value;
        }
        
        // Dispatch appropriate event
        if (name === 'season' || name === 'league') {
            dispatchEvent(EventTypes.BUTTON_PRESSED, name);
        } else if (name === 'week' || name === 'team' || name === 'teamView') {
            dispatchEvent(EventTypes.BUTTON_PRESSED, name);
        }
    });

    // --- External Event Handlers (for data source and palette changes) ---
    window.handleDataSourceChange = function() {
        dispatchEvent(EventTypes.DATA_SOURCE_CHANGED);
    };

    window.handlePaletteChange = function() {
        dispatchEvent(EventTypes.PALETTE_CHANGED);
    };

    // --- Palette switcher integration ---
    window.refreshAllCharts = function() {
        updateAllContent();
    };

    // --- Start initialization ---
    dispatchEvent(EventTypes.PAGE_LOADED);
}

// Handle selection changes
function handleSelectionChange() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    // Update URL parameters
    const url = new URL(window.location);
    if (selectedSeason) url.searchParams.set('season', selectedSeason);
    if (selectedLeague) url.searchParams.set('league', selectedLeague);
    window.history.pushState({}, '', url);
    
    const messageArea = document.getElementById('selectionMessage');
    const tableArea = document.getElementById('leagueTableHistory');
    
    if (selectedSeason && selectedLeague) {
        messageArea.style.display = 'none';
        tableArea.style.display = 'block';
        updateTableLeagueHistory();
        updateChartsLeague();
        // Also update week-specific content when season/league changes
        updateTableLeagueWeek();
        updateHonorScores();
        
    } else {
        messageArea.style.display = 'block';
        tableArea.style.display = 'none';
    }
}

// Update available weeks and teams when season/league selection changes
function updateAvailableOptions() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    const selectedTeam = document.querySelector('input[name="team"]:checked')?.value;

    console.log("Updating available options for:", {
        season: selectedSeason,
        league: selectedLeague
    });

    if (selectedSeason && selectedLeague) {
        // Update available weeks
        fetch(`/league/get_available_weeks?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(weeks => {
                const weekButtons = weeks.map(week => `
                    <input type="radio" class="btn-check" name="week" id="week_${week}" 
                           value="${week}" ${week.toString() === selectedWeek ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="week_${week}">${week}</label>
                `).join('');
                document.getElementById('buttonsWeek').innerHTML = weekButtons;
                // Select first week by default if none selected
                let weekInput = document.querySelector('input[name="week"]:checked');
                if (!weekInput && weeks.length > 0) {
                    weekInput = document.querySelector(`input[name="week"][value="${weeks[0]}"]`);
                    if (weekInput) {
                        weekInput.checked = true;
                        weekInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            })
            .catch(error => {
                console.error('Error loading weeks:', error);
                document.getElementById('buttonsWeek').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading weeks:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });

        // Update available teams
        fetch(`/league/get_available_teams?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(teams => {
                const teamButtons = teams.map(team => `
                    <input type="radio" class="btn-check" name="team" id="team_${team.replace(/\s+/g, '_')}" 
                           value="${team}" ${team === selectedTeam ? 'checked' : ''}>
                    <label class="btn btn-outline-primary" for="team_${team.replace(/\s+/g, '_')}">${team}</label>
                `).join('');
                document.getElementById('buttonsTeam').innerHTML = teamButtons;
                // Select first team by default if none selected
                let teamInput = document.querySelector('input[name="team"]:checked');
                if (!teamInput && teams.length > 0) {
                    teamInput = document.querySelector(`input[name="team"][value="${teams[0]}"]`);
                    if (teamInput) {
                        teamInput.checked = true;
                        teamInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            })
            .catch(error => {
                console.error('Error loading teams:', error);
                document.getElementById('buttonsTeam').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error loading teams:</strong> ${error.message || 'Unknown error'}
                    </div>
                `;
            });
    } else {
        // Clear buttons if no season/league selected
        document.getElementById('buttonsWeek').innerHTML = '';
        document.getElementById('buttonsTeam').innerHTML = '';
    }
}

// Handle week/team selection changes
function handleWeekTeamSelection() {
    const selectedWeek = document.querySelector('input[name="week"]:checked')?.value;
    const selectedTeam = document.querySelector('input[name="team"]:checked')?.value;
    
    // Update URL parameters
    const url = new URL(window.location);
    if (selectedWeek) url.searchParams.set('week', selectedWeek);
    if (selectedTeam) url.searchParams.set('team', selectedTeam);
    window.history.pushState({}, '', url);
    
    const messageArea = document.getElementById('weekMessage');
    const standingsTable = document.getElementById('tableLeagueWeek');
    
    if (selectedWeek) {
        messageArea.style.display = 'none';
        standingsTable.style.display = 'block';
        
        updateTableLeagueWeek();

        
        if (selectedTeam) {
            updateTableTeamDetails();
        }
    } else {
        messageArea.style.display = 'block';
        standingsTable.style.display = 'none';
    }
}

function updateHonorScores() {
    const selectedSeason = currentState?.season || document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = currentState?.league || document.querySelector('input[name="league"]:checked')?.value;
    const selectedWeek = currentState?.week || document.querySelector('input[name="week"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) {
        return;
    }
    
    if (!selectedWeek) {
        // Clear honor scores when no week is selected
        const pleaseSelectText = window.translations ? (window.translations['please_select_match_day'] || 'Please select a match day.') : 'Please select a match day.';
        document.getElementById('individualScores').innerHTML = `<div class="text-muted">${pleaseSelectText}</div>`;
        document.getElementById('teamScores').innerHTML = `<div class="text-muted">${pleaseSelectText}</div>`;
        document.getElementById('individualAverages').innerHTML = `<div class="text-muted">${pleaseSelectText}</div>`;
        document.getElementById('teamAverages').innerHTML = `<div class="text-muted">${pleaseSelectText}</div>`;
        return;
    }
    
    fetch(`/league/get_honor_scores?season=${selectedSeason}&league=${selectedLeague}&week=${selectedWeek}`)
        .then(response => response.json())
        .then(data => {
            // Individual Scores
            document.getElementById('individualScores').innerHTML = data.individual_scores
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.player}</span>
                    <span class="fw-bold">${item.score}</span>
                </div>`).join('');
            
            // Team Scores
            document.getElementById('teamScores').innerHTML = data.team_scores
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.team}</span>
                    <span class="fw-bold">${item.score}</span>
                </div>`).join('');
            
            // Individual Averages
            document.getElementById('individualAverages').innerHTML = data.individual_averages
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.player}</span>
                    <span class="fw-bold">${item.average.toFixed(1)}</span>
                </div>`).join('');
            
            // Team Averages
            document.getElementById('teamAverages').innerHTML = data.team_averages
                .map(item => `<div class="d-flex justify-content-between">
                    <span>${item.team}</span>
                    <span class="fw-bold">${item.average.toFixed(1)}</span>
                </div>`).join('');
        })
        .catch(error => console.error('Error:', error));
}

function updateTeamAveragesChart() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague) return;

    fetch(`/league/get_team_averages?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('teamAveragesChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.teamAveragesChart instanceof Chart) {
                window.teamAveragesChart.destroy();
            }
            
            window.teamAveragesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => `Week ${d.week}`),
                    datasets: [{
                        label: 'Average Points',
                        data: data.map(d => d.average),
                        borderColor: '#6FAED4',
                        backgroundColor: '#6FAED4',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Average Points for ${selectedTeam}`
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
}

function updateChartsLeague() {
    console.log('🔍 updateChartsLeague function called');
    
    const selectedSeason = currentState?.season || document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = currentState?.league || document.querySelector('input[name="league"]:checked')?.value;
    
    console.log('🔍 Selected season/league:', selectedSeason, selectedLeague);
    
    if (!selectedSeason || !selectedLeague) {
        console.log('🔍 Missing season or league, returning early');
        return;
    }
    
    // Fetch and create position charts
    fetch(`/league/get_team_positions?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            // Create labels based on number of weeks
            const numWeeks = Object.values(data.data)[0].length;
            const matchDayFormat = window.translations ? (window.translations['match_day_format'] || 'Match Day #{week}') : 'Match Day #{week}';
            const labels = Array.from({length: numWeeks}, (_, i) => matchDayFormat.replace('{week}', i + 1));

            // Create cumulative positions chart
            createLineChart(
                data.data,
                data.sorted_by_total,
                'chartTeamPositionCumulated',
                'ERROR: Position in Season Progress',
                labels,
                true,
                'exact'
            );

            updateSharedLegend(data.sorted_by_total);
        })
        .catch(error => {
            console.error('Error loading team positions:', error);
        });

    // Fetch and create points charts
    fetch(`/league/get_team_points?season=${selectedSeason}&league=${selectedLeague}`)
        .then(response => response.json())
        .then(data => {
            // Create labels based on number of weeks
            const numWeeks = Object.values(data.data)[0].length;
            const matchDayFormat = window.translations ? (window.translations['match_day_format'] || 'Match Day #{week}') : 'Match Day #{week}';
            const labels = Array.from({length: numWeeks}, (_, i) => matchDayFormat.replace('{week}', i + 1));

            createScatterChartMultiAxis(
                data.data,
                data.sorted_by_total,
                'chartTeamPointsWeekly',
                'Points per Match Day',
                labels
            );

            // Create cumulative positions chart
            createLineChart(
                data.data_accumulated,
                data.sorted_by_total,
                'chartTeamPointsCumulated',
                'Points in Season Progress',
                labels,
                false
            );
        })
        .catch(error => {
            console.error('Error loading team points:', error);
        });

        fetch(`/league/get_team_averages?season=${selectedSeason}&league=${selectedLeague}`)
    .then(response => response.json())
    .then(data => {
        console.log('=== TEAM AVERAGES DEBUG ===');
        console.log('Data structure:', {
            hasData: !!data.data,
            dataKeys: data.data ? Object.keys(data.data) : 'no data',
            hasOrder: !!data.sorted_by_total,
            orderLength: data.sorted_by_total ? data.sorted_by_total.length : 'no order'
        });
        
        const chartContainer = document.getElementById('chartTeamAverageScoreWeekly');
        if (!chartContainer) {
            console.error('❌ Chart container not found!');
            return;
        }
        
        const numWeeks = Object.values(data.data)[0].length;
        const matchDayFormat = window.translations ? (window.translations['match_day_format'] || 'Match Day #{week}') : 'Match Day #{week}';
        const labels = Array.from({length: numWeeks}, (_, i) => matchDayFormat.replace('{week}', i + 1));
        
        console.log('Creating chart with weeks:', numWeeks, 'labels:', labels.length);

        try {
            createLineChart(
                data.data,
                data.sorted_by_total,
                'chartTeamAverageScoreWeekly',
                'Average per Match Day',
                labels,
                false,
                'auto'
            );
            
            console.log('✅ Team averages chart created successfully');
        } catch (error) {
            console.error('❌ Error creating team averages chart:', error);
        }
        console.log('=== END TEAM AVERAGES DEBUG ===');
    })
    .catch(error => {
        console.error('❌ Error loading team averages:', error);
    });

}

// Initial load
document.addEventListener('DOMContentLoaded', initializePage);
document.addEventListener('DOMContentLoaded', function() {
    ['viewOwnTeam', 'viewOpponents', 'viewFull'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', function() {
                if (document.querySelector('input[name="teamView"]:checked')?.value === 'headToHead') {
                    updateTableTeamDetails();
                }
            });
        }
    });
});

    // --- Error Handling and User Feedback ---
    function showDataUnavailableMessage(message, elementId) {
        const element = document.getElementById(elementId);
        if (element) {
            element.innerHTML = `
                <div class="alert alert-warning">
                    <strong>Data Unavailable:</strong> ${message}
                    <br><small>This might be due to a data source change. Try refreshing the page or selecting different parameters.</small>
                </div>
            `;
        }
    }
    
    function handleDataRequestError(error, elementId, fallbackMessage = 'Data temporarily unavailable') {
        console.error('Data request error:', error);
        
        if (error.status === 404) {
            showDataUnavailableMessage('No data found for the current parameters. This might be due to a data source change.', elementId);
        } else {
            showDataUnavailableMessage(fallbackMessage, elementId);
        }
    }

    // --- Content Update Functions ---
</script>

{% endblock %}