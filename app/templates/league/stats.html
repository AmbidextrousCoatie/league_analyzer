{% extends "base.html" %}

{% block content %}
    {% from "components/tables.html" import create_table %}
    {{ create_table({}) }}

<div class="card">
    <div class="card-header">
        <h4>League Statistics</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Navigation Section -->
            <div class="col-md-6">
                <div class="mb-2">
                    <h5>Season</h5>
                    <div class="btn-group-horizontal w-100" role="group" id="seasonButtons">
                        {% for season in seasons %}
                        <input type="radio" class="btn-check" name="season" id="season_{{ season }}" value="{{ season }}">
                        <label class="btn btn-outline-primary text-start" for="season_{{ season }}">{{ season }}</label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-2">
                    <h5>League</h5>
                    <div class="btn-group-horizontal w-100" role="group" id="leagueButtons">
                        {% for league in leagues %}
                        <input type="radio" class="btn-check" name="league" id="league_{{ league }}" value="{{ league }}">
                        <label class="btn btn-outline-primary text-start" for="league_{{ league }}">{{ league }}</label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div> 
    </div>
</div>

<!-- League History Table -->
<div class="card">
    <div class="card-header">
        <h5>League Standings</h5>
    </div>
    <div class="card-body">
        <div id="leagueTableHistory">
            <!-- History table will be dynamically inserted here -->
        </div>
    </div>
</div>

<!-- Points Charts Container -->
<div class="card mb-3">
    <div class="card-header">
        <h5>Points over Time</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Points per Week Chart -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Points per Week</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="pointsChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Cumulative Points Chart -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Cumulative Points Development</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="cumulativePointsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Shared Legend -->
        <div class="row mt-3">
            <div class="col-12">
                <div id="sharedLegend" class="d-flex justify-content-center flex-wrap">
                    <!-- Legend will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mb-2">
    <h5>Match Day</h5>
    <div class="btn-group" role="group" id="matchDayButtons">
        {% for week in weeks %}
        <input type="radio" class="btn-check" name="matchDay" id="matchDay_{{ week }}" value="{{ week }}">
        <label class="btn btn-outline-primary" for="matchDay_{{ week }}">{{ week }}</label>
        {% endfor %}
    </div>
</div>

<!-- Team Selection -->
<div class="mb-2">
    <h5>Team</h5>
    <div class="btn-group-vertical w-100" role="group" id="teamButtons">
        <!-- Team buttons will be dynamically inserted here -->
    </div>
</div>
<!-- League Team Table -->
<div class="card">
    <div class="card-header">
        <h5>Team Results for Aschaffenburg 55</h5>
        <div id="teamDetailsMetadata" class="text-muted small"></div>
    </div>
    <div class="card-body">
        <div id="teamTableWeekDetails">
            <!-- Team table will be dynamically inserted here -->
            <div class="alert alert-info">Select season, league, and match day to view team details</div>
        </div>
    </div>
</div>




<div class="card">
    <div class="card-header">
        <h4>League Standings + single week</h4>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Content Section -->
            <div class="col-md-8">
                <div id="leagueTableStandings">
                    <!-- Table will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle season selection
    document.querySelectorAll('input[name="season"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                updateButtonsWeek();
            }
        });
    });

    // Handle league selection
    document.querySelectorAll('input[name="league"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                updateButtonsWeek();
            }
        });
    });

    // Handle league selection
    document.querySelectorAll('input[name="matchDay"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                updateButtonsWeek();
            }
        });
    });

    // Handle match day selection
    document.addEventListener('change', function(e) {
        if (e.target.name === 'matchDay') {
            updateButtonsWeek();
        }
    });

    function sortTable(sortKey) {
        const data = currentData.standings;  // Store the current data globally
        data.sort((a, b) => {
            const valA = sortKey.includes('Avg') ? a[sortKey] || 0 : a[sortKey] || 0;
            const valB = sortKey.includes('Avg') ? b[sortKey] || 0 : b[sortKey] || 0;
            return valB - valA;  // Descending order
        });
        updateTableDisplay(data);
    }

    function updateButtonsWeek() {
        const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
        const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
        const currentMatchDay = document.querySelector('input[name="matchDay"]:checked')?.value;
        
        if (selectedSeason && selectedLeague) {
            fetch(`/league/get_available_matchdays?season=${selectedSeason}&league=${selectedLeague}`)
                .then(response => response.json())
                .then(data => {
                    const matchDayButtons = document.getElementById('matchDayButtons');
                    const availableWeeks = data.matchdays;
                    
                    // Create match day buttons
                    const buttonsHtml = availableWeeks.map(week => `
                        <input type="radio" class="btn-check" name="matchDay" id="matchDay_${week}" value="${week}">
                        <label class="btn btn-outline-primary" for="matchDay_${week}">${week}</label>
                    `).join('');
                    
                    matchDayButtons.innerHTML = buttonsHtml;
                    
                    // Select match day: keep current if available, otherwise take latest
                    const latestMatchDay = Math.max(...availableWeeks);
                    if (currentMatchDay && availableWeeks.includes(parseInt(currentMatchDay))) {
                        document.getElementById(`matchDay_${currentMatchDay}`).checked = true;
                    } else {
                        document.getElementById(`matchDay_${latestMatchDay}`).checked = true;
                    }
                    
                    // Update table with selected match day
                    updateTableLeagueStandings();
                    updateTableLeagueHistory();
                    updateTableTeamDetails();
                    
                });
        }
    }
});

let positionChart = null;

// Color mapping function
const teamColors = {};

function getTeamColor(team) {
    if (!teamColors[team]) {
        // Generate and store a color for this team
        teamColors[team] = `hsl(${Object.keys(teamColors).length * 137.508}deg, 70%, 50%)`;
    }
    return teamColors[team];
}

function updateSharedLegend(teams) {
    const legendHtml = teams.map(team => `
        <div class="mx-3 mb-2 d-flex align-items-center">
            <div style="width: 20px; height: 20px; background-color: ${getTeamColor(team)}; margin-right: 8px;"></div>
            <span>${team}</span>
        </div>
    `).join('');
    
    document.getElementById('sharedLegend').innerHTML = legendHtml;
}

function updatePositionChart() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="matchDay"]:checked')?.value;
    
    if (selectedSeason && selectedLeague) {
        fetch(`/league/get_position_history?season=${selectedSeason}&league=${selectedLeague}&week=${currentWeek}&depth=${currentWeek}`)
            .then(response => response.json())
            .then(data => {
                // Destroy existing chart if it exists
                if (positionChart) positionChart.destroy();
                
                // Updated color palette
                const colors = [
                    '#28255c', '#592a6b', '#882c70', '#b4306b',
                    '#d8405e', '#f25b4a', '#ff7f30', '#ffa600'
                ];
                
                // Assign colors to teams
                const teamColors = data.teams.reduce((acc, team, index) => {
                    acc[team] = colors[index % colors.length];
                    return acc;
                }, {});
                
                // Create new chart
                positionChart = new Chart(document.getElementById('positionChart'), {
                    type: 'line',
                    data: {
                        labels: data.matchDays,
                        datasets: data.teams.map(team => ({
                            label: team,
                            data: data.data
                                .filter(d => d.team === team)
                                .sort((a, b) => a.matchDay - b.matchDay)
                                .map(d => d.position),
                            borderColor: teamColors[team],
                            backgroundColor: teamColors[team],
                            fill: false,
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            borderWidth: 2,
                            pointStyle: 'circle',
                        }))
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                reverse: true,
                                min: 0.5,
                                max: data.teams.length + 0.5,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : '';
                                    }
                                },
                                grid: {
                                    color: '#f0f0f0',
                                    offset: false,
                                    drawTicks: true,
                                    drawOnChartArea: true,
                                    // Align grid with integer positions
                                    z: 1,
                                    tickOffset: 0,
                                    tickLength: 0
                                },
                                afterFit: function(scaleInstance) {
                                    // Ensure grid lines align with positions
                                    scaleInstance.options.grid.offset = false;
                                },
                                afterDataLimits: (scale) => {
                                    // Align grid with integer positions
                                    scale.min = 0.5;
                                    scale.max = data.teams.length + 0.5;
                                },
                                title: { 
                                    display: true, 
                                    text: 'Position',
                                    font: { weight: 'bold' },
                                    padding: { top: 10, bottom: 10 }
                                }
                            },
                            x: {
                                grid: {
                                    drawTicks: true
                                },
                                title: {
                                    display: true,
                                    text: 'Match Day',
                                    font: { weight: 'bold' },
                                    padding: { top: 10, bottom: 10 }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const team = context.dataset.label;
                                        const position = context.parsed.y;
                                        const points = data.data.find(d => 
                                            d.team === team && d.matchDay === context.parsed.x
                                        ).points;
                                        return `${team}: Position ${position} (${points} pts)`;
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    boxWidth: 10
                                }
                            }
                        },
                        layout: {
                            padding: {
                                top: 10,
                                bottom: 10
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error:', error));
    }
}

// Update chart when selection changes
if (false){
    document.querySelectorAll('input[name="season"], input[name="league"]')
        .forEach(input => input.addEventListener('change', updatePositionChart));

// Initial chart update if selections exist
if (document.querySelector('input[name="season"]:checked') && 
    document.querySelector('input[name="league"]:checked')) {
    updatePositionChart();
}
}


function updateTableTeamDetails() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="matchDay"]:checked')?.value;
    const team = document.querySelector('input[name="team"]:checked')?.value;

    console.log("Updating team week details...");
    console.log("Season:", selectedSeason);
    console.log("League:", selectedLeague);
    console.log("Week:", currentWeek);
    console.log("Team:", team);

    if (!selectedSeason || !selectedLeague || !currentWeek) {
        console.log("Missing required selection");
        document.getElementById('teamTableWeekDetails').innerHTML = 
            '<div class="alert alert-warning">Please select season, league, and match day</div>';
        return;
    }


    document.querySelector('#teamTableWeekDetails').closest('.card')
        .querySelector('.card-header h5').textContent = `Results for Team ${team} in week ${currentWeek}`;
    

    document.getElementById('teamTableWeekDetails').innerHTML = 
        '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
    
    fetch(`/league/get_team_week_details?season=${selectedSeason}&league=${selectedLeague}&team=${team}&week=${currentWeek}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(response => {
            console.log("Received data:", response);
            
            if (!response.config) {
                throw new Error('Invalid response structure: missing config');
            }

            // Convert formatter strings to functions
            response.config.columns.forEach(col => {
                if (typeof col.formatter === 'string') {
                    try {
                        // Create a proper function from the string
                        col.formatter = new Function('value', 'row', `return ${col.formatter}`);
                    } catch (e) {
                        console.error(`Error creating formatter for column ${col.key}:`, e);
                        col.formatter = value => value; // Fallback formatter
                    }
                }
            });

            // Create the table
            const tableHtml = createTable(response.config);
            document.getElementById('teamTableWeekDetails').innerHTML = tableHtml;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('teamTableWeekDetails').innerHTML = 
                `<div class="alert alert-danger">
                    Error loading team details: ${error.message}<br>
                    Please try again or contact support if the problem persists.
                </div>`;
        });
}

function updateTablePosition(data) {
    const table = document.getElementById('positionHistoryTable');
    
    // Update headers
    const headerRow = table.querySelector('thead tr');
    headerRow.innerHTML = '<th>Team</th>';
    data.weeks.forEach(week => {
        headerRow.innerHTML += `
            <th colspan="2">Week ${week}</th>
        `;
    });
    
    // Add subheader row for Points/Average
    const subheaderRow = document.createElement('tr');
    subheaderRow.innerHTML = '<th></th>';  // Empty cell for team name
    data.weeks.forEach(() => {
        subheaderRow.innerHTML += `
            <th>Points</th>
            <th>Average</th>
        `;
    });
    table.querySelector('thead').appendChild(subheaderRow);
    
    // Update body
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    data.data.forEach(teamData => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${teamData.team}</td>`;
        
        teamData.weeks.forEach(week => {
            row.innerHTML += `
                <td>${week.points.toFixed(1)}</td>
                <td>${week.average.toFixed(2)}</td>
            `;
        });
        
        tbody.appendChild(row);
    });
}

function updateTableLeagueHistory() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="matchDay"]:checked')?.value;
    
    if (!selectedSeason || !selectedLeague || !currentWeek) {
        console.log("Missing required selection");
        return;
    }
    
    fetch(`/league/get_league_history?season=${selectedSeason}&league=${selectedLeague}&week=${currentWeek}&depth=${currentWeek}`)
        .then(response => response.json())
        .then(data => {
            // Create table configuration
            const tableConfig = {
                id: 'leagueTableHistory',
                headerGroups: data.headerGroups,
                columns: data.columns,
                data: data.data,
                sortable: true
            };

            // Call the createTable function from components/tables.html
            const tableHtml = createTable(tableConfig);
            document.getElementById('leagueTableHistory').innerHTML = tableHtml;
            
            // Update chart
            updatePointsChart(data);
            updateCumulativePointsChart(data);
        })
        .catch(error => console.error('Error:', error));
}

function updateTableLeagueStandings() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentWeek = document.querySelector('input[name="matchDay"]:checked')?.value;
    
    console.log('Attempting to update standings table with:', {
        season: selectedSeason,
        league: selectedLeague,
        week: currentWeek
    });
    
    if (!selectedSeason || !selectedLeague || !currentWeek) {
        console.log("Missing required selection");
        return;
    }
    
    const url = `/league/get_league_standings?season=${selectedSeason}&league=${selectedLeague}&week=${currentWeek}&depth=${currentWeek}`;
    console.log('Fetching from URL:', url);
    
    fetch(url)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            const tableConfig = {
                id: 'leagueTableStandings',
                headerGroups: data.headerGroups,
                columns: data.columns,
                data: data.data,
                sortable: true
            };

            const tableHtml = createTable(tableConfig);
            document.getElementById('leagueTableStandings').innerHTML = tableHtml;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('leagueTableStandings').innerHTML = 
                `<div class="alert alert-danger">Error loading standings: ${error.message}</div>`;
        });
}


/*
// Add event listeners
document.querySelectorAll('input[name="season"], input[name="league"], input[name="matchDay"]')
    .forEach(input => input.addEventListener('change', updateHistoryTable));

document.querySelectorAll('input[name="season"], input[name="league"], input[name="matchDay"]')
    .forEach(input => input.addEventListener('change', updateLeagueStandingsTable));

document.querySelectorAll('input[name="season"], input[name="league"], input[name="matchDay"]')
    .forEach(input => input.addEventListener('change', updateTeamWeekDetails));


// Initial load
document.addEventListener('DOMContentLoaded', updateHistoryTable);
document.addEventListener('DOMContentLoaded', updateLeagueStandingsTable);
document.addEventListener('DOMContentLoaded', updateTeamWeekDetails);
*/
// Event listeners for filter changes
function setupEventListeners() {
    const filters = document.querySelectorAll('input[name="season"], input[name="league"], input[name="matchDay"], input[name="team"]');
    
    filters.forEach(input => {
        input.addEventListener('change', () => {
            console.log(`Filter changed: ${input.name} = ${input.value}`);
            updateTableTeamDetails();
        });
    });
}

// Initial load
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Content Loaded - Setting up team details");
    setupEventListeners();
    updateTableTeamDetails();
});

function updateButtonsTeams() {
    const selectedSeason = document.querySelector('input[name="season"]:checked')?.value;
    const selectedLeague = document.querySelector('input[name="league"]:checked')?.value;
    const currentTeam = document.querySelector('input[name="team"]:checked')?.value;
    
    if (selectedSeason && selectedLeague) {
        fetch(`/league/get_available_teams?season=${selectedSeason}&league=${selectedLeague}`)
            .then(response => response.json())
            .then(teams => {
                const teamButtons = document.getElementById('teamButtons');
                
                // Create team buttons
                const buttonsHtml = teams.map(team => `
                    <input type="radio" class="btn-check" name="team" id="team_${team}" value="${team}">
                    <label class="btn btn-outline-primary" for="team_${team}">${team}</label>
                `).join('');
                
                teamButtons.innerHTML = buttonsHtml;
                
                // Select team: keep current if available, otherwise take first
                if (currentTeam && teams.includes(currentTeam)) {
                    document.getElementById(`team_${currentTeam}`).checked = true;
                } else if (teams.length > 0) {
                    document.getElementById(`team_${teams[0]}`).checked = true;
                }
                
                // Update relevant tables/charts
                updateTableLeagueStandings();
                updateTableLeagueHistory();
                updateTableTeamDetails();

                // Add listeners to new team buttons
                document.querySelectorAll('input[name="team"]')
                    .forEach(input => input.addEventListener('change', updateTableTeamDetails));
            });
    }
}

// Add event listeners
document.querySelectorAll('input[name="season"], input[name="league"]')
    .forEach(input => input.addEventListener('change', updateButtonsTeams));

// Add event listeners for team selection
document.addEventListener('change', function(event) {
    if (event.target.name === 'team') {
        updateTableTeamDetails();
    }
});

function updatePointsChart(data) {
    // Get the canvas element
    const canvas = document.getElementById('pointsChart');
    
    // Destroy existing chart if it exists
    if (window.pointsChart instanceof Chart) {
        window.pointsChart.destroy();
    }
    
    // Extract teams and their point progression
    const teams = [...new Set(data.data.map(row => row[0]))];  // Get unique team names
    const weekCount = (data.headerGroups.length - 2);  // Subtract Team and Total columns
    
    // Create datasets for each team
    const datasets = teams.map(team => {
        const teamData = data.data.find(row => row[0] === team);
        const points = [];
        
        // Extract only points (every 3rd value, starting from index 3)
        for (let i = 0; i < weekCount; i++) {
            const pointsIndex = (i * 2) + 2;  // Skip team name, and take every 3rd value (Score, Average, Points)
            points.push(teamData[pointsIndex]);  // +2 to get to Points after Score and Average
        }
        
        // Generate a random color for the team
        const color = getTeamColor(team);
        
        return {
            label: team,
            data: points,
            borderColor: color,
            backgroundColor: color,
            tension: 0.1
        };
    });

    // Create new chart
    const ctx = canvas.getContext('2d');
    window.pointsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: weekCount}, (_, i) => `Week ${i + 1}`),
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Points Development Over Time'
                },
                legend: {
                    display: false  // Hide individual chart legend
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Points'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Week'
                    }
                }
            }
        }
    });
    
    // Update shared legend
    updateSharedLegend(teams);
}

function updateCumulativePointsChart(data) {
    // Get the canvas element
    const canvas = document.getElementById('cumulativePointsChart');
    
    // Destroy existing chart if it exists
    if (window.cumulativePointsChart instanceof Chart) {
        window.cumulativePointsChart.destroy();
    }
    
    // Extract teams and their point progression
    const teams = [...new Set(data.data.map(row => row[0]))];
    const weekCount = (data.headerGroups.length - 2);
    
    // Create datasets for each team
    const datasets = teams.map(team => {
        const teamData = data.data.find(row => row[0] === team);
        const points = [];
        let cumulativePoints = 0;
        
        // Extract points and accumulate them
        for (let i = 0; i < weekCount; i++) {
            const pointsIndex = (i * 2) + 2;
            const weekPoints = parseFloat(teamData[pointsIndex]); // +2 to get Points after Score and Average
            cumulativePoints += weekPoints;
            points.push(cumulativePoints);
        }
        
        // Generate a random color for the team (use same color as previous chart)
        const color = getTeamColor(team);
        
        return {
            label: team,
            data: points,
            borderColor: color,
            backgroundColor: color,
            tension: 0.1
        };
    });

    // Create new chart
    const ctx = canvas.getContext('2d');
    window.cumulativePointsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array.from({length: weekCount}, (_, i) => `Week ${i + 1}`),
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Cumulative Points Over Time'
                },
                legend: {
                    display: false  // Hide individual chart legend
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Total Points'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Week'
                    }
                }
            }
        }
    });
}

function createTable(config) {
    const {
        data,
        columns,
        headerGroups = [],  // This contains the actual colspan values
        rowNumbering = true,
        positionChange = false
    } = config;

    let currentData = [...data];

    // Get colors for groups using #2196F3 as end color
    const getGroupColors = () => {
        const endColor = '#7ec2f8';  // Bootstrap primary blue
        const startRGB = [255, 255, 255];  // white
        const endRGB = hexToRgb(endColor);
        
        return headerGroups.map((_, index) => {
            if (index === 0) return 'rgb(255, 255, 255)';  // First group is white
            if (index === headerGroups.length - 1) return endColor;  // Last group is primary blue
            
            const factor = index / (headerGroups.length - 1);
            const r = Math.round(startRGB[0] + (endRGB[0] - startRGB[0]) * factor);
            const g = Math.round(startRGB[1] + (endRGB[1] - startRGB[1]) * factor);
            const b = Math.round(startRGB[2] + (endRGB[2] - startRGB[2]) * factor);
            
            return `rgb(${r}, ${g}, ${b})`;
        });
    };

    const hexToRgb = (hex) => {
        hex = hex.replace(/^#/, '');
        const bigint = parseInt(hex, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r, g, b];
    };

    const colors = getGroupColors();

    // Create mappings for column colors and last group columns
    const columnColors = {};
    const lastGroupColumns = {};
    let currentColumn = 0;
    headerGroups.forEach((group, groupIndex) => {
        const isLastGroup = groupIndex === headerGroups.length - 1;
        const colspan = group.colspan || 1;  // Get actual colspan from the group
        for (let i = 0; i < colspan; i++) {
            columnColors[currentColumn] = colors[groupIndex];
            lastGroupColumns[currentColumn] = isLastGroup;
            currentColumn++;
        }
    });

    const createHeaderGroups = () => {
        if (!headerGroups || headerGroups.length === 0) return '';
        
        return `
            <tr>
                ${headerGroups.map((group, index) => `
                    <th class="text-center" 
                        colspan="${group.colspan || 1}" 
                        style="background-color: ${colors[index]}; 
                               color: ${index === headerGroups.length - 1 ? 'white' : 'black'};">
                        ${group.title || ''}
                    </th>
                `).join('')}
            </tr>
        `;
    };

    const createColumnHeaders = () => {
        return `
            <tr>
                ${columns.map((col, index) => `
                    <th class="text-center" 
                        style="background-color: ${columnColors[index]};
                               color: ${lastGroupColumns[index] ? 'white' : 'black'};
                               font-weight: ${lastGroupColumns[index] ? 'bold' : 'normal'};">
                        ${col.title || ''}
                    </th>
                `).join('')}
            </tr>
        `;
    };

    const createTableRows = () => {
        return currentData.map((row, rowIndex) => `
            <tr>
                ${columns.map((col, colIndex) => `
                    <td class="text-center" 
                        style="background-color: ${columnColors[colIndex]};
                               color: ${lastGroupColumns[colIndex] ? 'white' : 'black'};
                               font-weight: ${lastGroupColumns[colIndex] ? 'bold' : 'normal'};
                               border-right: ${(colIndex < columns.length - 1 && 
                                              columnColors[colIndex] !== columnColors[colIndex + 1]) 
                                             ? '2px solid #dee2e6' 
                                             : '1px solid #dee2e6'};">
                        ${row[colIndex] !== undefined ? row[colIndex] : ''}
                    </td>
                `).join('')}
            </tr>
        `).join('');
    };

    return `
        <table class="table">
            <thead>
                ${createHeaderGroups()}
                ${createColumnHeaders()}
            </thead>
            <tbody>
                ${createTableRows()}
            </tbody>
        </table>
    `;
}

</script>
{% endblock %}