{% extends "base.html" %}
{% block content %}
    {% include "components/tables.html" %}
    {% include "components/charts.html" %}

    <style>
        /* Ensure Bootstrap button styling works properly */
        .btn-check:checked + .btn-outline-primary {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
            color: white !important;
        }
        
        .btn-check:focus + .btn-outline-primary {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
        }
    </style>

    <!-- Selection Message -->
    <div id="selectionMessage" class="alert alert-danger fs-4">
        Bitte wählen Sie ein Team.
    </div>

    <!-- Filter Controls -->
    <div class="card">
        <div class="card-header">
            <h4>Team Statistics</h4>
        </div>
        <div class="card-body">
            <!-- Selection Area -->
            <div class="row">
                <div class="col-md-3">
                    <h5>Team</h5>
                    <select id="teamSelect" class="form-select">
                        <option value="">Bitte wählen...</option>
                    </select>
                </div>
                <div class="col-md-9">
                    <h5>Saison</h5>
                    <div id="buttonsSeason" class="btn-group-horizontal w-100">
                        <!-- Seasons will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h5>Spieltag</h5>
                    </div>
                    <div class="card-body">
                        <div id="buttonsWeek" class="btn-group-vertical w-100">
                            <!-- Buttons will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team History Chart (Content Block) -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Platzierungsverlauf 
                        <span class="badge bg-success ms-2">Content Block</span>
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="chartTeamHistory" width="800" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- League Comparison Section (Content Block) -->
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Leistung vs. Liga-Durchschnitt 
                        <span class="badge bg-success ms-2">Content Block</span>
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="chartLeagueComparison" width="600" height="400"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Liga-Vergleich Details</h5>
                </div>
                <div class="card-body">
                    <div id="tableLeagueComparison"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clutch & Consistency Section (Legacy) -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Clutch Performance 
                        <span class="badge bg-success ms-2">Content Block</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="chartClutchPerformance" style="height: 300px;"></div>
                    <div id="clutchStats" class="mt-3">
                        <!-- Clutch statistics will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Consistency Metrics 
                        <span class="badge bg-success ms-2">Content Block</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="consistencyMetrics">
                        <!-- Consistency metrics will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Special Moments Section (Content Block) -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Besondere Momente 
                <span class="badge bg-success ms-2">Content Block</span>
            </h4>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Highest Scores Section -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Höchste Ergebnisse</h5>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Score</th>
                                        <th>Event</th>
                                        <th>Gegner</th>
                                    </tr>
                                </thead>
                                <tbody id="highestScoresBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Lowest Scores Section -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Niedrigste Ergebnisse</h5>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Score</th>
                                        <th>Event</th>
                                        <th>Gegner</th>
                                    </tr>
                                </thead>
                                <tbody id="lowestScoresBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Biggest Win Margins Section -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Höchste Siege</h5>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Differenz</th>
                                        <th>Ergebnis</th>
                                        <th>Event</th>
                                        <th>Gegner</th>
                                    </tr>
                                </thead>
                                <tbody id="biggestWinsBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Biggest Loss Margins Section -->
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Höchste Niederlagen</h5>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Differenz</th>
                                        <th>Ergebnis</th>
                                        <th>Event</th>
                                        <th>Gegner</th>
                                    </tr>
                                </thead>
                                <tbody id="biggestLossesBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Legacy JavaScript Modules -->
    <script src="{{ static_url('js/legacy/team-chart-utils.js') }}"></script>
    <script src="{{ static_url('js/legacy/team-filter-utils.js') }}"></script>
    <script src="{{ static_url('js/legacy/team-data-utils.js') }}"></script>

    <!-- Import State Management Components -->
    <script src="{{ static_url('js/core/url-state-manager.js') }}"></script>
    <script src="{{ static_url('js/core/centralized-button-manager.js') }}"></script>

    <!-- Import Chart Adapters -->
    <script src="{{ static_url('js/chart-adapters.js') }}"></script>

    <!-- Import Content Blocks -->
    <script src="{{ static_url('js/content-blocks/base-content-block.js') }}"></script>
    <script src="{{ static_url('js/content-blocks/team-history-block.js') }}"></script>
    <script src="{{ static_url('js/content-blocks/league-comparison-block.js') }}"></script>
    <script src="{{ static_url('js/content-blocks/clutch-analysis-block.js') }}"></script>
    <script src="{{ static_url('js/content-blocks/consistency-metrics-block.js') }}"></script>
    <script src="{{ static_url('js/content-blocks/special-matches-block.js') }}"></script>

    <!-- Import Content Renderer -->
    <script src="{{ static_url('js/core/content-renderer.js') }}"></script>

    <!-- Import Main Application Coordinator -->
    <script src="{{ static_url('js/team-stats-app.js') }}"></script>
    <script>
        // Create global app instance
        window.teamStatsApp = new TeamStatsApp();

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing TeamStatsApp...');
            
            // Longer delay to ensure all components are ready
            setTimeout(() => {
                window.teamStatsApp.initialize().catch(error => {
                    console.error('❌ Failed to initialize TeamStatsApp:', error);
                });
            }, 200);
        });

        // Enhanced debug functions
        window.debugTeamStats = () => window.teamStatsApp.debug();
        window.refreshTeamStats = () => window.teamStatsApp.refreshContent();
        window.testTeamStats = () => window.teamStatsApp.testState();
    </script>

    <!-- Debug Panel -->
    <div class="card mt-4" style="border-color: #6f42c1;">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">Team Stats Debug Panel</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="debugTeamStats()">Debug State</button>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshTeamStats()">Refresh Content</button>
                    <button class="btn btn-sm btn-outline-danger me-2" onclick="window.teamStatsApp.clearAllFilters()">Clear Filters</button>
                    <button class="btn btn-sm btn-outline-info me-2" onclick="testTeamStats()">Test State</button>
                    <button class="btn btn-sm btn-outline-success" onclick="console.log('Current State:', window.teamStatsApp.getState())">Show State</button>
                </div>
                <div class="col-md-4 text-end">
                    <small class="text-muted">Content Block System Active</small>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <small class="text-muted">
                        <span class="badge bg-success me-1">Content Block</span> = New modular system |
                        <span class="badge bg-warning me-1">Legacy</span> = Old function calls
                    </small>
                </div>
            </div>
        </div>
    </div>
{% endblock %}