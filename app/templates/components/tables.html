<link href="https://unpkg.com/tabulator-tables@6.3.0/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.0/dist/js/tabulator.min.js"></script>

<script>
function createTable(config) {
    const {
        data,
        columns,
        headerGroups = [],  // This contains the actual colspan values
        rowNumbering = true,
        positionChange = false
    } = config;

    let currentData = [...data];

    // Get colors for groups using #2196F3 as end color
    const getGroupColors = () => {
        const endColor = '#7ec2f8';  // Bootstrap primary blue
        const startRGB = [255, 255, 255];  // white
        const endRGB = hexToRgb(endColor);
        
        return headerGroups.map((_, index) => {
            if (index === 0) return 'rgb(255, 255, 255)';  // First group is white
            if (index === headerGroups.length - 1) return endColor;  // Last group is primary blue
            
            const factor = index / (headerGroups.length - 1);
            const r = Math.round(startRGB[0] + (endRGB[0] - startRGB[0]) * factor);
            const g = Math.round(startRGB[1] + (endRGB[1] - startRGB[1]) * factor);
            const b = Math.round(startRGB[2] + (endRGB[2] - startRGB[2]) * factor);
            
            return `rgb(${r}, ${g}, ${b})`;
        });
    };

    const hexToRgb = (hex) => {
        hex = hex.replace(/^#/, '');
        const bigint = parseInt(hex, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r, g, b];
    };

    const colors = getGroupColors();

    // Create mappings for column colors and last group columns
    const columnColors = {};
    const lastGroupColumns = {};
    let currentColumn = 0;
    headerGroups.forEach((group, groupIndex) => {
        const isLastGroup = groupIndex === headerGroups.length - 1;
        const colspan = group.colspan || 1;  // Get actual colspan from the group
        for (let i = 0; i < colspan; i++) {
            columnColors[currentColumn] = colors[groupIndex];
            lastGroupColumns[currentColumn] = isLastGroup;
            currentColumn++;
        }
    });

    const createHeaderGroups = () => {
        if (!headerGroups || headerGroups.length === 0) return '';
        
        return `
            <tr>
                ${headerGroups.map((group, index) => `
                    <th class="text-center" 
                        colspan="${group.colspan || 1}" 
                        style="background-color: ${colors[index]}; 
                               color: ${index === headerGroups.length - 1 ? 'white' : 'black'};">
                        ${group.title || ''}
                    </th>
                `).join('')}
            </tr>
        `;
    };

    const createColumnHeaders = () => {
        return `
            <tr>
                ${columns.map((col, index) => `
                    <th class="text-center" 
                        style="background-color: ${columnColors[index]};
                               color: ${lastGroupColumns[index] ? 'white' : 'black'};
                               font-weight: ${lastGroupColumns[index] ? 'bold' : 'normal'};">
                        ${col.title || ''}
                    </th>
                `).join('')}
            </tr>
        `;
    };

    const createTableRows = () => {
        return currentData.map((row, rowIndex) => `
            <tr>
                ${columns.map((col, colIndex) => `
                    <td class="text-center" 
                        style="background-color: ${columnColors[colIndex]};
                               color: ${lastGroupColumns[colIndex] ? 'white' : 'black'};
                               font-weight: ${lastGroupColumns[colIndex] ? 'bold' : 'normal'};
                               border-right: ${(colIndex < columns.length - 1 && 
                                              columnColors[colIndex] !== columnColors[colIndex + 1]) 
                                             ? '2px solid #dee2e6' 
                                             : '1px solid #dee2e6'};">
                        ${row[colIndex] !== undefined ? row[colIndex] : ''}
                    </td>
                `).join('')}
            </tr>
        `).join('');
    };

    return `
        <table class="table">
            <thead>
                ${createHeaderGroups()}
                ${createColumnHeaders()}
            </thead>
            <tbody>
                ${createTableRows()}
            </tbody>
        </table>
    `;
}


// Function to convert hex color to RGB
const hexToRgb = (hex) => {
    const bigint = parseInt(hex.slice(1), 16);
    const r = (bigint >> 16) & 255;
    const g = (bigint >> 8) & 255;
    const b = bigint & 255;
    return [r, g, b];
};

// Function to get colors for groups
const getGroupColors = (headerGroups) => {
    const endColor = '#2196F3';  // Bootstrap primary blue
    const startRGB = [255, 255, 255];  // white
    const endRGB = hexToRgb(endColor);
    
    return headerGroups.map((_, index) => {
        if (index === 0) return 'rgb(255, 255, 255)';  // First group is white
        if (index === headerGroups.length - 1) return endColor;  // Last group is primary blue
        
        const factor = index / (headerGroups.length - 1) * (0.8-0.2) + 0.2;
        const r = Math.round(startRGB[0] + (endRGB[0] - startRGB[0]) * factor);
        const g = Math.round(startRGB[1] + (endRGB[1] - startRGB[1]) * factor);
        const b = Math.round(startRGB[2] + (endRGB[2] - startRGB[2]) * factor);
        
        return `rgb(${r}, ${g}, ${b})`;
    });
};

function createTableTabulator(tableId, data) {
    // Check if the data has columns and data
    if (!data || !data.columns || !data.data) {
        console.error('Invalid data format');
        return;
    }

    // Transform the data from array format to object format
    const transformedData = data.data.map(row => {
        const obj = {};
        let index = 0; // Initialize index to track the position in the row array

        // Loop through each column group
        data.columns.forEach(colGroup => {
            if (colGroup.columns) {
                // Loop through each column in the group
                colGroup.columns.forEach(col => {
                    obj[col.field] = row[index]; // Assign the value from the row to the object
                    index++; // Increment index for the next field
                });
            }
        });
        return obj; // Return the transformed object
    });

    // Process columns to ensure frozen properties are set and add group indices
    const processedColumns = data.columns.map((col, index) => {
        const newCol = { ...col };
        if (newCol.columns) {
            const color = getGroupColors(data.columns)[index];
            const isLastGroup = index === data.columns.length - 1;  // Check if this is the last group
            newCol.cssClass = `group-${index}`;
            // Apply the color to all child columns
            newCol.columns = newCol.columns.map(subCol => ({ 
                ...subCol,
                formatter: function(cell, formatterParams, onRendered) {
                    cell.getElement().style.backgroundColor = color;
                    // Check if this is the last group
                    if (isLastGroup) {
                        cell.getElement().style.color = 'white';
                        cell.getElement().style.fontWeight = 'bold';
                    }
                    return cell.getValue();
                }
            }));
        }
        return newCol;
    });

    // Destroy existing instance if it exists
    if (window[tableId + 'Instance']) {
        window[tableId + 'Instance'].destroy();
    }

    // Function to create a lighter version of a color
    const getLighterColor = (color) => {
        // If color is in rgb format, convert it
        let rgb;
        if (color.startsWith('rgb')) {
            rgb = color.match(/\d+/g).map(Number);
        } else if (color.startsWith('#')) {
            rgb = hexToRgb(color);
        }
        
        return rgb;
        // Make it 85% lighter
        //const lighter = rgb.map(c => Math.round(c + (255 - c) * 0.85));
        //return `rgb(${lighter[0]}, ${lighter[1]}, ${lighter[2]})`;
    };

    // Create new Tabulator instance
    window[tableId + 'Instance'] = new Tabulator(`#${tableId}`, {
        data: transformedData,
        columns: processedColumns,
        layout: "fitDataStretch",
        responsiveLayout: false,
        pagination: false,
        movableColumns: false,
        tooltips: false,
        height: "auto",
        columnDefaults: {
            resizable: true,
            formatter: "plaintext",
            minWidth: 50,
            maxWidth: 200,
            headerHozAlign: "center",
            hozAlign: "center"
        },
        rowHeight: 40,
        theme: "bootstrap",
        cssClass: "custom-tabulator",
        columnHeaderVertAlign: "middle",
        columnHeaderStyling: function(column) {
            if (column.getParentColumn()) {
                const parentTitle = column.getParentColumn().getDefinition().title;
                const groupIndex = data.columns.findIndex(col => col.title === parentTitle);
                const colors = getGroupColors(data.columns);
                return {backgroundColor: colors[groupIndex]};
            }
        }
    });

    // Apply header colors after table is fully rendered
    window[tableId + 'Instance'].on("tableBuilt", function() {
        setTimeout(() => {
            const headers = document.querySelectorAll(`#${tableId} .tabulator-col-group`);
            const colors = getGroupColors(data.columns);
            
            headers.forEach((header, index) => {
                const color = colors[index];
                const isLastGroup = index === data.columns.length - 1;
                
                // Apply color to header
                header.style.setProperty('background-color', color, 'important');
                
                // Apply styles to header and all its children
                const elements = [header, ...header.querySelectorAll('*')];
                elements.forEach(element => {
                    element.style.setProperty('background-color', color, 'important');
                    if (isLastGroup) {
                        element.style.setProperty('color', 'white', 'important');
                        element.style.setProperty('font-weight', 'bold', 'important');
                    }
                });
            });

            console.log('Colors applied to headers');
        }, 100);
    });

    console.log(`Table "${tableId}" successfully created/updated`);
}

</script>

<style>
/* Custom Tabulator Styling */
/* General Table Styles */
.custom-tabulator {
    border: none; /* Remove default borders */
    background-color: transparent; /* Make background transparent */
    font-family: 'Your Custom Font', sans-serif; /* Use your site's font */
}

/* Header Styles */
.custom-tabulator .tabulator-header {
    background-color: #f8f9fa; /* Light background for header */
    color: #343a40; /* Dark text color */
    font-weight: bold; /* Bold header text */
    border-bottom: 2px solid #dee2e6; /* Subtle border */
}

/* Column Styles */
.custom-tabulator .tabulator-col {
    border-right: 1px solid #dee2e6; /* Subtle column borders */
}

.custom-tabulator .tabulator-col .tabulator-col-content {
    padding: 10px; /* Add padding for better spacing */
}

/* Row Styles */
.custom-tabulator .tabulator-row {
    border-bottom: 1px solid #dee2e6; /* Subtle row borders */
}

.custom-tabulator .tabulator-row.tabulator-row-even {
    background-color: #f9f9f9; /* Light gray for even rows */
}

.custom-tabulator .tabulator-row.tabulator-row-odd {
    background-color: #ffffff; /* White for odd rows */
}

/* Hover Effects */
.custom-tabulator .tabulator-row:hover {
    background-color: #e9ecef; /* Light hover effect */
}

/* Frozen Column Styles */
.custom-tabulator .tabulator-frozen {
    background-color: #ffffff; /* Background for frozen columns */
    z-index: 10; /* Ensure frozen columns are above others */
}

/* Scrollbar Styles */
.custom-tabulator .tabulator-tableHolder::-webkit-scrollbar {
    width: 8px; /* Width of the scrollbar */
}

.custom-tabulator .tabulator-tableHolder::-webkit-scrollbar-track {
    background: #f1f1f1; /* Track color */
}

.custom-tabulator .tabulator-tableHolder::-webkit-scrollbar-thumb {
    background: #888; /* Thumb color */
    border-radius: 4px; /* Rounded corners */
}

.custom-tabulator .tabulator-tableHolder::-webkit-scrollbar-thumb:hover {
    background: #555; /* Darker thumb on hover */
}

/* Add this to your CSS file or style section */
.tabulator-col-group {
    background-color: white !important;
}

.tabulator-col-group[data-group-index="0"] {
    background-color: rgb(255, 255, 255) !important;
}

.tabulator-col-group[data-group-index="1"] {
    background-color: rgb(242, 247, 251) !important;
}

.tabulator-col-group[data-group-index="2"] {
    background-color: rgb(229, 239, 247) !important;
}

/* Add more rules based on your number of groups */
</style> 