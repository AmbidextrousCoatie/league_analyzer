{% macro create_table(config) %}
<script>
function createTable(config) {
    const {
        data,                    // Array of objects containing the data
        columns,                // Array of column definitions
        headerGroups = [],      // Optional grouped headers
        rowNumbering = true,    // Whether to show row numbers
        positionChange = false  // Whether to show position changes
    } = config;

    let currentData = [...data];  // Make a copy of the data for sorting
    
    // Create grouped headers if any
    const createHeaderGroups = () => {
        if (!headerGroups || headerGroups.length === 0) return '';
        
        // Debug log to see what we're getting
        console.log('headerGroups:', headerGroups);
        
        return `
            <tr>
                ${headerGroups.map(group => `
                    <th class="text-center" colspan="${group.colspan || 1}">
                        ${group.title || ''}
                    </th>
                `).join('')}
            </tr>
        `;
    };

    // Create position change indicator
    const createPositionChange = (change) => {
        if (!change) return '';
        if (change > 0) return `<span class="text-success">↑${change}</span>`;
        if (change < 0) return `<span class="text-danger">↓${Math.abs(change)}</span>`;
        return '';
    };

    // Create table row
    const createRow = (row, index) => `
        <tr>
            ${rowNumbering ? `
                <td>
                    ${index + 1}
                    ${positionChange ? createPositionChange(row.positionChange) : ''}
                </td>
            ` : ''}
            ${columns.map(col => `
                <td class="${col.className || ''}" style="${col.style || ''}">${
                    col.formatter ? col.formatter(row[col.key], row) : (row[col.key] || '0')
                }</td>
            `).join('')}
        </tr>`;

    // Sorting function
    function sortData(key, ascending = true) {
        currentData.sort((a, b) => {
            let valueA = a[key] ?? '';
            let valueB = b[key] ?? '';
            
            // Handle numeric values
            if (!isNaN(valueA) && !isNaN(valueB)) {
                valueA = Number(valueA);
                valueB = Number(valueB);
            }
            
            if (valueA < valueB) return ascending ? -1 : 1;
            if (valueA > valueB) return ascending ? 1 : -1;
            return 0;
        });
    }

    // Track sort state
    const sortState = {
        column: null,
        ascending: true
    };

    // Create header with sort handlers
    const createHeader = () => `
        <tr>
            ${rowNumbering ? '<th>#</th>' : ''}
            ${columns.map(col => `
                <th class="${col.className || ''} ${col.sortable ? 'sortable' : ''}" 
                    data-sort="${col.key}"
                    onclick="${col.sortable ? `sortColumn('${col.key}')` : ''}"
                    style="${col.style || ''}"
                >
                    ${col.title}
                    ${col.sortable ? `<span class="sort-indicator"></span>` : ''}
                </th>
            `).join('')}
        </tr>`;

    const styles = `
        <style>
            .sortable {
                cursor: pointer;
                position: relative;
            }
            .sortable:hover {
                background-color: rgba(0,0,0,0.05);
            }
            .sort-indicator::after {
                content: '↕';
                margin-left: 5px;
                opacity: 0.3;
            }
            .sort-asc .sort-indicator::after {
                content: '↑';
                opacity: 1;
            }
            .sort-desc .sort-indicator::after {
                content: '↓';
                opacity: 1;
            }
        </style>
    `;

    // Function to render the table
    function renderTable() {
        const tableHtml = `
            ${styles}
            <table class="table table-striped table-hover">
                <thead>
                    ${createHeaderGroups()}
                    ${createHeader()}
                </thead>
                <tbody>
                    ${currentData.map((row, index) => createRow(row, index)).join('')}
                </tbody>
            </table>
        `;
        return tableHtml;
    }

    // Add global sort function
    window.sortColumn = function(key) {
        const th = document.querySelector(`th[data-sort="${key}"]`);
        
        // Update sort state
        if (sortState.column === key) {
            sortState.ascending = !sortState.ascending;
        } else {
            sortState.column = key;
            sortState.ascending = true;
        }

        // Update sort indicators
        document.querySelectorAll('th.sortable').forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
        });
        th.classList.add(sortState.ascending ? 'sort-asc' : 'sort-desc');

        // Sort data
        sortData(key, sortState.ascending);
        
        // Re-render table body
        const tbody = th.closest('table').querySelector('tbody');
        tbody.innerHTML = currentData.map((row, index) => createRow(row, index)).join('');
    };

    // Return initial table render
    return renderTable();
}
</script>
{% endmacro %}
